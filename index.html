<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tracking V23 - Real Time</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --orange: #ff8c00; --green: #28a745; --bg: #fffaf5; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); }
        .hidden { display: none !important; }
        .glass-card { background: white; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange); color: white; border-radius: 50px; font-weight: 600; border: none; padding: 10px 20px; transition: 0.3s; }
        .btn-refresh { background: #6c757d; color: white; border-radius: 10px; font-size: 0.8rem; border: none; padding: 5px 15px; }
        .stat-box { border-left: 5px solid var(--orange); background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .badge-count { position: absolute; top: 5px; right: 10px; background: var(--orange); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .nav-btn { flex: 1; border-radius: 12px; font-weight: 600; }
        .table-custom { font-size: 0.85rem; text-align: center; }
        .table-custom thead { background: var(--orange); color: white; }
        .last-update { font-size: 0.75rem; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div id="loginSection" class="container d-flex align-items-center justify-content-center" style="min-height:100vh;">
    <div class="glass-card text-center shadow" style="max-width:400px; width:100%;">
        <h3 class="fw-bold mb-4 text-orange">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <input type="text" id="user" class="form-control mb-3" placeholder="Username">
        <input type="password" id="pass" class="form-control mb-4" placeholder="Password">
        <button onclick="login()" class="btn btn-orange w-100 shadow">Login</button>
    </div>
</div>

<div id="mainSection" class="hidden">
    <nav class="navbar mb-3 p-3 glass-card mx-2 mt-2">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand fw-bold text-orange">üü† PERFORMANCE V23</span>
            <div id="liveClock" class="fw-bold text-secondary">00:00:00</div>
            <div class="small fw-bold">üë§ <span id="empName"></span></div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex gap-2 mb-4">
            <button id="nav-rec" class="btn btn-orange nav-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button id="nav-dash" class="btn btn-outline-secondary nav-btn" onclick="showTab('dash')">Dashboard</button>
            <button id="nav-assign" class="btn btn-outline-secondary nav-btn" onclick="showTab('assign')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center mb-3">
                <h5 id="displayDateText" class="fw-bold mb-3"></h5>
                <div class="row g-2">
                    <div class="col-6"><div class="stat-box">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span id="displayTarget" class="fw-bold text-orange">0</span></div></div>
                    <div class="col-6"><div class="stat-box" style="border-left-color:var(--green)">‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏ß‡∏°: <span id="displayActual" class="fw-bold text-success">0</span></div></div>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-6 col-md-4">
                    <div class="stat-box">üì¶ CP No. <span class="badge-count" id="count-CP">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="CP No.">
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="stat-box">üìû Call IN <span class="badge-count" id="count-Call">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="Call IN">
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="stat-box">üìÑ IR <span class="badge-count" id="count-IR">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="IR">
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="stat-box">üåê GNS <span class="badge-count" id="count-GNS">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="GNS">
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="stat-box">üõ†Ô∏è SR <span class="badge-count" id="count-SR">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="SR">
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="stat-box">üéÅ Campaign <span class="badge-count" id="count-Campaign">0</span>
                        <input type="text" class="form-control mt-1 cat-input" data-cat="Campaign">
                    </div>
                </div>
            </div>
            <button onclick="saveWork()" class="btn btn-orange w-100 mt-4 py-3 shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-dash" class="tab-content hidden">
            <div class="glass-card mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold text-orange m-0">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                    <div>
                        <button onclick="refreshView(true)" class="btn-refresh">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <div class="last-update text-end">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastSyncTime">-</span></div>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-md-3">
                        <select id="viewType" class="form-select" onchange="toggleFilters()">
                            <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                            <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="quarterly">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option>
                            <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="divYear"><select id="selYear" class="form-select" multiple onchange="updateSubFilters()"></select></div>
                    <div class="col-md-3" id="divMonth"><select id="selMonth" class="form-select" multiple onchange="updateDayFilter()"></select></div>
                    <div class="col-md-3" id="divDay"><select id="selDay" class="form-select" multiple></select></div>
                </div>
                <button onclick="processDashboard()" class="btn btn-orange w-100 mt-3">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="glass-card" style="height: 350px;"><canvas id="perfChart"></canvas></div>

            <div class="glass-card">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered table-custom">
                        <thead>
                            <tr><th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th><th>‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</th><th>Call IN</th><th>IR</th><th>CP</th><th>GNS</th><th>SR</th><th>Camp.</th></tr>
                        </thead>
                        <tbody id="dashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden">
            <div class="glass-card mb-4">
                <h5 class="fw-bold text-orange mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h5>
                <div class="row g-2">
                    <div class="col-md-5"><input type="date" id="planDate" class="form-control"></div>
                    <div class="col-md-4"><select id="planType" class="form-select"><option value="72">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (72)</option><option value="36">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô (36)</option></select></div>
                    <div class="col-md-3"><button onclick="savePlan('save')" class="btn btn-orange w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                </div>
            </div>
            <div class="glass-card"><div class="table-responsive"><table class="table table-sm table-custom w-100 text-center"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="planTableBody"></tbody></table></div></div>
        </div>

    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    let currentUser = "", allData = [], allPlans = [], chartInstance = null;

    setInterval(() => {
        document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('th-TH');
        document.getElementById('displayDateText').innerText = '‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + new Date().toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'});
    }, 1000);

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('btn-orange', 'btn-outline-secondary'));
        document.getElementById('nav-' + (tabName === 'record' ? 'rec' : tabName)).classList.replace('btn-outline-secondary', 'btn-orange');
        if(tabName === 'dash') initDashboard();
    }

    async function login() {
        const u = document.getElementById('user').value.trim();
        const p = document.getElementById('pass').value.trim();
        if(!u || !p) return;
        Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
        try {
            const res = await (await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)).json();
            if (res.status === "success") {
                currentUser = res.name;
                document.getElementById('empName').innerText = res.name;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                await refreshView();
                Swal.close();
            } else { Swal.fire('Error', 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        } catch (e) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error'); }
    }

    async function refreshView(manual = false) {
        if(manual) Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', timer: 500, didOpen:()=>Swal.showLoading()});
        
        const res = await (await fetch(SCRIPT_URL)).json();
        allData = res.data.slice(1);
        allPlans = res.plans.slice(1);
        
        const today = new Date().toISOString().split('T')[0];
        const userPlans = allPlans.filter(p => p[1] === currentUser);
        const todayData = allData.filter(d => d[0].split('T')[0] === today && d[1] === currentUser);
        
        // Update Record Tab Counters
        document.getElementById('displayTarget').innerText = userPlans.find(p => p[0].split('T')[0] === today)?.[3] || 0;
        document.getElementById('displayActual').innerText = todayData.length;
        
        const cats = { "CP": "CP No.", "Call": "Call IN", "IR": "IR", "GNS": "GNS", "SR": "SR", "Campaign": "Campaign" };
        for (let id in cats) {
            document.getElementById(`count-${id}`).innerText = todayData.filter(d => d[2] === cats[id]).length;
        }

        // Update Dashboard Sync Time
        document.getElementById('lastSyncTime').innerText = new Date().toLocaleTimeString('th-TH');

        // Update Plan Table
        let planHtml = "";
        userPlans.sort((a,b) => new Date(b[0]) - new Date(a[0])).slice(0,10).forEach(p => {
            planHtml += `<tr><td>${new Date(p[0]).toLocaleDateString('th-TH')}</td><td>${p[3]}</td><td><button class="btn btn-sm btn-danger" onclick="savePlan('delete', '${p[0].split('T')[0]}')">‡∏•‡∏ö</button></td></tr>`;
        });
        document.getElementById('planTableBody').innerHTML = planHtml || '<tr><td colspan="3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô</td></tr>';
    }

    async function saveWork() {
        const entries = [];
        document.querySelectorAll('.cat-input').forEach(i => { if(i.value.trim()) entries.push({category: i.dataset.cat, caseId: i.value.trim()}); });
        if(!entries.length) return;
        
        Swal.showLoading();
        const res = await (await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'saveData', date: new Date().toISOString().split('T')[0], employee: currentUser, target: document.getElementById('displayTarget').innerText, entries})})).json();
        
        if(res.status === "success") {
            document.querySelectorAll('.cat-input').forEach(i => i.value = "");
            await refreshView(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Counter ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1000, showConfirmButton:false});
        } else { Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', res.msg, 'error'); }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö Dashboard (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V22 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•)
    function initDashboard() {
        const years = [...new Set(allPlans.filter(p => p[1] === currentUser).map(p => new Date(p[0]).getFullYear()))].sort((a,b)=>b-a);
        document.getElementById('selYear').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
        toggleFilters();
    }
    function toggleFilters() {
        const t = document.getElementById('viewType').value;
        document.getElementById('divMonth').classList.toggle('hidden', t === 'yearly');
        document.getElementById('divDay').classList.toggle('hidden', t !== 'daily');
        updateSubFilters();
    }
    function updateSubFilters() {
        const t = document.getElementById('viewType').value;
        const selM = document.getElementById('selMonth');
        if (t === 'daily' || t === 'monthly') {
            const ms = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
            selM.innerHTML = ms.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
        } else if (t === 'quarterly') {
            selM.innerHTML = `<option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option>`;
        }
    }
    function updateDayFilter() {
        if(document.getElementById('viewType').value !== 'daily') return;
        const ys = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const ms = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        let ds = allPlans.filter(p => p[1] === currentUser && ys.includes(new Date(p[0]).getFullYear().toString()) && ms.includes((new Date(p[0]).getMonth()+1).toString())).map(p => p[0].split('T')[0]);
        document.getElementById('selDay').innerHTML = [...new Set(ds)].sort().map(d => `<option value="${d}">${new Date(d).getDate()}/${new Date(d).getMonth()+1}</option>`).join('');
    }

    function processDashboard() {
        const type = document.getElementById('viewType').value;
        const sY = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const sM = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        const sD = Array.from(document.getElementById('selDay').selectedOptions).map(o => o.value);
        
        let groups = {};
        allPlans.filter(p => p[1] === currentUser).forEach(p => {
            const d = new Date(p[0]), y = d.getFullYear().toString(), m = (d.getMonth()+1).toString(), q = Math.ceil(m/3).toString(), f = p[0].split('T')[0];
            let k = "";
            if(type === 'yearly' && sY.includes(y)) k = y;
            else if(type === 'quarterly' && sY.includes(y) && sM.includes(q)) k = `Q${q}/${y}`;
            else if(type === 'monthly' && sY.includes(y) && sM.includes(m)) k = `${m}/${y}`;
            else if(type === 'daily' && sD.includes(f)) k = f;
            if(k) { if(!groups[k]) groups[k] = { t: 0, a: 0, c: {} }; groups[k].t += parseInt(p[3]); }
        });

        allData.filter(d => d[1] === currentUser).forEach(d => {
            const date = new Date(d[0]), y = date.getFullYear().toString(), m = (date.getMonth()+1).toString(), q = Math.ceil(m/3).toString(), f = d[0].split('T')[0], cat = d[2];
            let k = "";
            if(type === 'yearly' && sY.includes(y)) k = y;
            else if(type === 'quarterly' && sY.includes(y) && sM.includes(q)) k = `Q${q}/${y}`;
            else if(type === 'monthly' && sY.includes(y) && sM.includes(m)) k = `${m}/${y}`;
            else if(type === 'daily' && sD.includes(f)) k = f;
            if(k && groups[k]) { groups[k].a++; groups[k].c[cat] = (groups[k].c[cat] || 0) + 1; }
        });

        if (chartInstance) chartInstance.destroy();
        const labs = Object.keys(groups);
        chartInstance = new Chart(document.getElementById('perfChart'), {
            type: 'bar',
            data: { labels: labs, datasets: [{ label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', data: labs.map(l => groups[l].t), backgroundColor: '#28a745' }, { label: '‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á', data: labs.map(l => groups[l].a), backgroundColor: '#ff8c00' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        let html = "";
        labs.forEach(l => {
            html += `<tr><td class="fw-bold">${l}</td><td>${groups[l].t}</td><td class="text-primary">${groups[l].a}</td><td>${groups[l].c['Call IN']||0}</td><td>${groups[l].c['IR']||0}</td><td>${groups[l].c['CP No.']||0}</td><td>${groups[l].c['GNS']||0}</td><td>${groups[l].c['SR']||0}</td><td>${groups[l].c['Campaign']||0}</td></tr>`;
        });
        document.getElementById('dashTableBody').innerHTML = html || '<tr><td colspan="9">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }

    async function savePlan(action, date) {
        if(action === 'delete' && !(await Swal.fire({title:'‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ?', showCancelButton:true})).isConfirmed) return;
        Swal.showLoading();
        await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'savePlan', subAction: action, date: date || document.getElementById('planDate').value, employee: currentUser, target: document.getElementById('planType').value, workType:'Plan'})});
        await refreshView();
        Swal.close();
    }
</script>
</body>
</html>