<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V.92 - Hybrid Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <style>
        :root { 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --deep-orange: #e65100;
            --bright-orange: #ff8c00;
            --bg-liquid: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
        }

        /* Base UI */
        body { font-family: 'Prompt', sans-serif; background: var(--bg-liquid); min-height: 100vh; color: #2d3436; margin: 0; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 15px; }
        .hidden-completely { display: none !important; }

        /* Navigation */
        .nav-btn { border: none; background: none; color: #636e72; font-weight: 600; padding: 10px; transition: 0.3s; flex: 1; font-size: 0.85rem; border-radius: 12px; }
        .nav-btn.active-btn { background: var(--bright-orange); color: white; box-shadow: 0 4px 10px rgba(255,140,0,0.3); }

        /* Dashboard Filter Grid */
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; align-items: stretch; width: 100%; }
        .filter-box { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; display: flex; flex-direction: column; }
        .filter-box select { width: 100%; border: 1px solid #ccc; border-radius: 5px; padding: 4px; margin-top: 5px; flex-grow: 1; font-size: 0.8rem; }
        .filter-label { font-weight: bold; font-size: 0.8rem; color: #555; }

        /* Progress & Badges */
        .progress-wrapper { background: rgba(0,0,0,0.05); height: 26px; border-radius: 13px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8c00, #ffb347, #ff8c00); transition: width 1s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
        .count-circle { background: linear-gradient(135deg, #ff9100, #ffea00); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; margin-right: 4px; }

        /* CP Detail Table */
        .cp-table-render { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; background: white; border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .cp-table-render td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .cp-label-custom { background-color: #fff8e1; font-weight: 600; color: var(--deep-orange); width: 40%; border-right: 1px solid #f0f0f0; }
        .cp-value-custom { background-color: #ffffff; color: #333; }
        .cp-section-title { background: linear-gradient(90deg, var(--bright-orange), var(--deep-orange)); color: white; font-weight: bold; padding: 8px 15px; font-size: 0.9rem; }

        /* Loader */
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--bright-orange); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏•‡∏∞ Responsive --- */

            /* 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Container ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
                .container {
                    max-width: 100% !important; 
                    width: 100% !important;
                    padding: 0 15px !important;
                }

            /* 2. ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö Tab ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
                .glass-card.d-flex.gap-1 {
                    display: flex !important;
                    width: 100%;
                    justify-content: space-between;
                }

                .nav-btn {
                    flex: 1; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡∏´‡∏≤‡∏£ 4 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) */
                    text-align: center;
                    padding: 12px 5px;
                    font-size: 0.9rem;
                    border-radius: 12px !important;
                }

            /* 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Tab Content) ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
                .tab-content, .glass-card {
                    width: 100% !important;
                }

            /* 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ CP ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
                .table-responsive {
                    width: 100%;
            overflow-x: auto; /* ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
}
    </style>
</head>
<body>

<section id="loginSection" style="position:fixed; inset:0; z-index:9999; background:var(--bg-liquid); display:flex; align-items:center; justify-content:center;">
    <div class="glass-card text-center shadow-lg" style="width:90%; max-width:350px;">
        <h3 class="fw-bold mb-4" style="color:var(--deep-orange)">üçä Performance</h3>
        <div id="loginInputs">
            <input type="text" id="user" class="form-control rounded-pill mb-3" placeholder="Username">
            <input type="password" id="pass" class="form-control rounded-pill mb-4" placeholder="Password">
            <button onclick="login()" class="btn btn-warning w-100 fw-bold text-white rounded-pill py-2 shadow-sm">LOGIN</button>
        </div>
        <div id="loginStatus" class="hidden-completely">
            <div class="loader-spinner"></div>
            <p class="mb-1 fw-bold text-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</p>
            <p id="targetUserDisplay" class="text-warning small"></p>
        </div>
    </div>
</section>

<main id="mainSection" class="hidden-completely">
<nav class="navbar glass-card m-2 p-2">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div style="flex: 1;">
            <span class="fw-bold" style="color:var(--bright-orange)">üçä PERFORMANCE V.92</span>
        </div>

        <div style="flex: 1;" class="text-center">
            <div id="currentDateTimeDisplay" style="line-height: 1.2;">
                <div id="displayDate" style="font-size: 11px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</div>
                <div id="displayTime" style="font-size: 18px; font-weight: bold; color: var(--bright-orange);">00:00:00</div>
            </div>
        </div>

        <div style="flex: 1;" class="text-end">
            <div class="small">
                <b id="empName">nuttawut thummajinda</b> | 
                <a href="#" onclick="location.reload()" class="text-danger text-decoration-none">‡∏≠‡∏≠‡∏Å</a>
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 2px;">
                <i class="fas fa-sync-alt fa-spin text-success"></i> 
                Auto Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="autoSyncTime">-</span>
            </div>
        </div>
    </div>
</nav>
    <div class="container">
        <div class="glass-card d-flex gap-1 p-1 mb-3" style="border-radius: 15px; overflow-x: auto;">
            <button id="nav-record" class="btn nav-btn active-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="nav-cp" class="btn nav-btn" onclick="showTab('cp')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î CP</button>
            <button id="nav-dash" class="btn nav-btn" onclick="showTab('dash')">‡∏™‡∏£‡∏∏‡∏õ</button>
            <button id="nav-assign" class="btn nav-btn" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>
        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center">
                <div class="progress-wrapper mb-3"><div id="goalProgress" class="progress-bar-fill">0%</div></div>
                <div class="row g-2 mb-4 border-bottom pb-3">
                <div class="col-4">Target<br><b id="displayTarget">0</b></div>
                <div class="col-4 text-primary">Actual<br><b id="displayActual">0</b></div>
                <div class="col-4">Balance<br><b id="displayBalance">0</b></div>
                </div>

                <div class="row g-3">
                    <div class="col-4 small"><span class="count-circle" id="badge-CP">0</span> CP<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="CP No." placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Call">0</span> Call<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Call IN" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-IR">0</span> IR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="IR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-SR">0</span> SR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="SR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Drop">0</span> Drop<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Drop Call" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Camp">0</span> Camp<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Campaign" placeholder="ID"></div>
                </div>
                
                <button onclick="saveWork()" class="btn btn-warning w-100 text-white fw-bold py-3 mt-4 rounded-pill shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold m-0 small"><i class="fa-solid fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistoryVisibility()">
                        <i class="fa-solid fa-eye"></i> ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
                    </button>
                </div>
                <div id="historyContent" class="hidden-completely">
                    <div class="table-responsive">
                        <table class="table table-sm" style="font-size: 0.75rem;">
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cp" class="tab-content">
    <div class="glass-card">
        <h6 class="fw-bold mb-3" style="color:var(--deep-orange)">
            <i class="fa-solid fa-bolt me-2"></i>Smart CP Splitter
        </h6>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="small fw-bold text-primary">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G (IMSI ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2 / Signal 7,8):</label>
                <textarea id="cpInput4G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-danger">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G (Signal ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 9,10):</label>
                <textarea id="cpInput5G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-success">3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address):</label>
                <textarea id="cpInputAddr" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà..." oninput="parseCPData()"></textarea>
            </div>
        </div>
        
        <div class="table-responsive">
    <table class="cp-table-render" id="cpTable">
        <thead>
            <tr><th colspan="2" class="cp-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)</th></tr>
        </thead>
        <tbody>
            <tr><td class="cp-label-custom">IMSI :</td><td id="td-imsi" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GCell Name:</td><td id="td-4gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4G Signal Strength :</td><td id="td-4grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GSignal Quality :</td><td id="td-4grsrq" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GCell Name:</td><td id="td-5gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5G Signal Strength :</td><td id="td-5grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GSignal Quality :</td><td id="td-5gsinr" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address) :</td><td id="td-address" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Remark :</td><td id="td-remark" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Arpu :</td><td id="td-arpu" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Service Year :</td><td id="td-service-year" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package :</td><td id="td-package" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package Remaining :</td><td id="td-package-remaining" class="cp-value-custom" contenteditable="true">-</td></tr>
        </tbody>
    </table>
</div>

        <div class="row g-2 mt-3">
            <div class="col-4">
                    <button class="btn btn-light w-100 rounded-pill border fw-bold" onclick="clearCP()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
                <div class="col-8">
                    <button class="btn btn-warning w-100 rounded-pill text-white fw-bold shadow" onclick="copyCPTable()">
                    <i class="fa-regular fa-copy me-2"></i>Copy Table
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-chart-line me-2"></i>Performance Summary</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning active" id="btn-bar" onclick="changeChartType('bar')">Bar</button>
                        <button class="btn btn-outline-warning" id="btn-line" onclick="changeChartType('line')">Line</button>
                    </div>
                </div>

                <div class="filter-row mb-3">
                    <div class="filter-box"><label class="filter-label">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="viewType" onchange="updateDashFilters()"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option></select></div>
                    <div class="filter-box"><label class="filter-label">‡∏õ‡∏µ</label><select id="selYear" onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="monthBox"><label class="filter-label" id="lblSub">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select id="selSub" multiple onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="dayBox"><label class="filter-label">‡∏ß‡∏±‡∏ô</label><select id="selDay" multiple onchange="processDashboard()"></select></div>
                </div>

                <div style="height: 350px;"><canvas id="perfChart"></canvas></div>
                
                <div class="table-responsive mt-3" style="max-height: 300px;">
                    <table class="table table-sm text-center small">
                        <thead class="table-light sticky-top">
                            <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>Actual</th><th>Target</th><th>%</th></tr>
                        </thead>
                        <tbody id="dashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
    <div class="glass-card mb-3">
        <h6 class="fw-bold mb-3" style="color:var(--deep-orange)">
            <i class="fa-solid fa-calendar-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </h6>
        <div class="row g-2">
            <div class="col-6">
                <label class="small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="planDate" class="form-control form-control-sm">
            </div>
            <div class="col-6">
                <label class="small fw-bold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target)</label>
                <input type="number" id="planTarget" class="form-control form-control-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
            </div>
            <div class="col-12 mt-3">
                <button onclick="saveNewPlan()" class="btn btn-primary w-100 rounded-pill">
                    <i class="fa-solid fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h6 class="fw-bold mb-3"><i class="fa-solid fa-list-check me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
        <div class="table-responsive">
            <table class="table table-sm text-center small">
                <thead class="table-light">
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>Target</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="planTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>
</main>


<script>
    // --- 1. CONFIG & GLOBALS ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    const MONTHS_TH = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    let currentUser = "", allData = [], allPlans = [], chartInstance = null, currentChartType = 'bar';

    // --- 2. AUTH ---
    async function login() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return;
        document.getElementById('loginInputs').classList.add('hidden-completely');
        document.getElementById('loginStatus').classList.remove('hidden-completely');
        document.getElementById('targetUserDisplay').innerText = `User: ${u}`;
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.status === "success") {
                currentUser = data.name;
                document.getElementById('empName').innerText = currentUser;
                document.getElementById('loginSection').classList.add('hidden-completely');
                document.getElementById('mainSection').classList.remove('hidden-completely');
                initData();
                setInterval(initData, 60000);
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                document.getElementById('loginInputs').classList.remove('hidden-completely');
                document.getElementById('loginStatus').classList.add('hidden-completely');
            }
        } catch(e) { location.reload(); }
    }

    // --- 3. DATA ENGINE ---
    async function initData() {
    try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();
        allData = json.data.slice(1);
        allPlans = json.plans.slice(1);
        
        setupFilters(); // <--- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô
        updateHomeStats();
        updateHistory();
        renderPlanTable();
        
        if (chartInstance) processDashboard();
    } catch(e) { console.error("Sync Error:", e); }
}

// --- 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô) ---
let myChart = null;

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ---
function renderChart(groups) {
    const canvas = document.getElementById('perfChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    const labels = Object.keys(groups).sort();
    const actualData = labels.map(k => groups[k].total);
    const targetData = labels.map(k => groups[k].target);

    // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≠‡∏ô)
    if (myChart) {
        myChart.destroy();
    }

myChart = new Chart(ctx, {
    type: typeof currentChartType !== 'undefined' ? currentChartType : 'bar',
    plugins: [ChartDataLabels], 
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Actual',
                data: actualData,
                backgroundColor: '#ffa500', 
                borderColor: '#ffa500',
                borderWidth: 1,
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold' },
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏° % ‡∏Ç‡∏≠‡∏á Target ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                    color: function(context) {
                        const index = context.dataIndex;
                        const actual = context.dataset.data[index];
                        const target = targetData[index];
                        const pct = target > 0 ? (actual / target) * 100 : 0;

                        if (pct <= 20) return '#dc3545'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        if (pct < 100) return '#cc9a06'; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° (‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß)
                        return '#28a745'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    }
                }
            },
            {
                label: 'Target',
                data: targetData,
                type: 'line', 
                borderColor: '#ff6384',
                borderDash: [5, 5],
                fill: false,
                datalabels: {
                    display: false // ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô Target ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                }
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 30 } },
        plugins: {
            legend: { position: 'top' },
            datalabels: {
                display: true,
                formatter: (value) => value > 0 ? value : ''
            }
        },
        scales: { y: { beginAtZero: true } }
    }
});
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ)
function setupFilters() {
    const selYear = document.getElementById('selYear');
    if (selYear.options.length > 0) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥
    
    const curY = new Date().getFullYear();
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    [curY, curY - 1].forEach(y => selYear.add(new Option(y + 543, y)));
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô 1-31
    const selDay = document.getElementById('selDay');
    selDay.innerHTML = "";
    for (let d = 1; d <= 31; d++) {
        const opt = new Option(d, d, false, true); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô default
        selDay.add(opt);
    }
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateDashFilters();
}

function updateDashFilters() {
    const type = document.getElementById('viewType').value;
    const selSub = document.getElementById('selSub');
    const monthBox = document.getElementById('monthBox');
    const dayBox = document.getElementById('dayBox');
    const lblSub = document.getElementById('lblSub');

    if (!selSub) return; // ‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    selSub.innerHTML = "";

    if (type === 'daily' || type === 'monthly') {
        monthBox.classList.remove('hidden-completely');
        lblSub.innerText = (type === 'daily') ? "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å MONTHS_TH
        MONTHS_TH.forEach((m, i) => {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            const isSelected = (type === 'daily') ? (i === new Date().getMonth()) : true;
            selSub.add(new Option(m, i + 1, false, isSelected));
        });
        
        // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        dayBox.classList.toggle('hidden-completely', type === 'monthly');
    } 
    else if (type === 'quarterly') {
        monthBox.classList.remove('hidden-completely');
        dayBox.classList.add('hidden-completely');
        lblSub.innerText = "‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™";
        [1, 2, 3, 4].forEach(q => {
            selSub.add(new Option(`Q${q}`, q, false, true));
        });
    }

    processDashboard();
}

   async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // 1. ‡πÅ‡∏™‡∏î‡∏á Loading
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            inputs.forEach(i => i.value = ""); 
            
            // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                html: result.message,
                timer: 1000, 
                showConfirmButton: false 
            });

            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ Dashboard)
            await initData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Server
            
            if (typeof processDashboard === 'function') {
                processDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}

function processDashboard() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Filter ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Dashboard
    const type = document.getElementById('viewType').value;
    const year = document.getElementById('selYear').value;
    const sub = Array.from(document.getElementById('selSub').selectedOptions).map(o => parseInt(o.value));
    const days = Array.from(document.getElementById('selDay').selectedOptions).map(o => parseInt(o.value));

    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    const todayStr = new Date().toLocaleDateString('en-CA');
    let todayStats = { cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0, total: 0, target: 0 };
    let groups = {};

    // 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Actual
    allData.forEach(d => {
        const dt = new Date(d[0]);
        const rowDateStr = dt.toLocaleDateString('en-CA');
        const cat = d[2];
        
        if (d[1] !== currentUser) return;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
        if (rowDateStr === todayStr) {
            todayStats.total++;
            if (cat === "CP No.") todayStats.cp++;
            else if (cat === "Call IN") todayStats.call++;
            else if (cat === "IR") todayStats.ir++;
            else if (cat === "SR") todayStats.sr++;
            else if (cat === "Drop Call") todayStats.drop++;
            else if (cat === "Campaign") todayStats.camp++;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ---
        if (dt.getFullYear() != year) return;
        const m = dt.getMonth() + 1;
        const q = Math.ceil(m / 3);

        if ((type === 'daily' || type === 'monthly') && !sub.includes(m)) return;
        if (type === 'daily' && !days.includes(dt.getDate())) return;
        if (type === 'quarterly' && !sub.includes(q)) return;

        const key = type === 'daily' ? rowDateStr : (type === 'monthly' ? `${year}-${m}` : `Q${q}`);
        
        if (!groups[key]) {
            groups[key] = { total: 0, target: 0, cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0 };
        }
        
        groups[key].total++;
        if (cat === "CP No.") groups[key].cp++;
        else if (cat === "Call IN") groups[key].call++;
        else if (cat === "IR") groups[key].ir++;
        else if (cat === "SR") groups[key].sr++;
        else if (cat === "Drop Call") groups[key].drop++;
        else if (cat === "Campaign") groups[key].camp++;
    });

    // 4. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Target
    allPlans.forEach(p => {
        const dt = new Date(p[0]);
        const rowDateStr = dt.toLocaleDateString('en-CA');
        if (p[1] !== currentUser || dt.getFullYear() != year) return;

        const m = dt.getMonth() + 1;
        const key = type === 'daily' ? rowDateStr : (type === 'monthly' ? `${year}-${m}` : `Q${Math.ceil(m/3)}`);
        
        if (rowDateStr === todayStr) todayStats.target = parseInt(p[3] || 0);
        if (groups[key]) groups[key].target += parseInt(p[3] || 0);
    });

    updateTodayUI(todayStats);
    renderChart(groups);
    renderDashTable(groups);
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Update ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
function processDashboard() {
    const type = document.getElementById('viewType').value;
    const year = document.getElementById('selYear').value;
    const sub = Array.from(document.getElementById('selSub').selectedOptions).map(o => parseInt(o.value));
    const days = Array.from(document.getElementById('selDay').selectedOptions).map(o => parseInt(o.value));

    const todayStr = new Date().toLocaleDateString('en-CA');
    let todayStats = { cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0, total: 0, target: 0 };
    let groups = {};

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Actual
    allData.forEach(d => {
        const dt = new Date(d[0]);
        const rowDateStr = dt.toLocaleDateString('en-CA');
        if (d[1] !== currentUser) return;

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        if (rowDateStr === todayStr) {
            todayStats.total++;
            const cat = d[2];
            if (cat === "CP No.") todayStats.cp++;
            else if (cat === "Call IN") todayStats.call++;
            else if (cat === "IR") todayStats.ir++;
            else if (cat === "SR") todayStats.sr++;
            else if (cat === "Drop Call") todayStats.drop++;
            else if (cat === "Campaign") todayStats.camp++;
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard
        if (dt.getFullYear() != year) return;
        const m = dt.getMonth() + 1;
        const q = Math.ceil(m / 3);
        if ((type === 'daily' || type === 'monthly') && !sub.includes(m)) return;
        if (type === 'daily' && !days.includes(dt.getDate())) return;
        if (type === 'quarterly' && !sub.includes(q)) return;

        const key = type === 'daily' ? rowDateStr : (type === 'monthly' ? `${year}-${m}` : `Q${q}`);
        if (!groups[key]) groups[key] = { total: 0, target: 0, cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0 };
        
        groups[key].total++;
        const cat = d[2];
        if (cat === "CP No.") groups[key].cp++;
        else if (cat === "Call IN") groups[key].call++;
        else if (cat === "IR") groups[key].ir++;
        else if (cat === "SR") groups[key].sr++;
        else if (cat === "Drop Call") groups[key].drop++;
        else if (cat === "Campaign") groups[key].camp++;
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Target
    allPlans.forEach(p => {
        const dt = new Date(p[0]);
        const rowDateStr = dt.toLocaleDateString('en-CA');
        if (p[1] !== currentUser) return;

        if (rowDateStr === todayStr) todayStats.target = parseInt(p[3] || 0);

        if (dt.getFullYear() == year) {
            const m = dt.getMonth() + 1;
            const key = type === 'daily' ? rowDateStr : (type === 'monthly' ? `${year}-${m}` : `Q${Math.ceil(m/3)}`);
            if (groups[key]) groups[key].target += parseInt(p[3] || 0);
        }
    });

    // ‡∏™‡∏±‡πà‡∏á Update UI ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ)
updateTodayUI(todayStats);
    updateHistory(); 
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô groups ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    if (typeof renderChart === "function") {
        renderChart(groups); 
    }
    renderDashTable(groups);
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞ Progress Bar ‡πÑ‡∏•‡πà‡∏™‡∏µ
function updateTodayUI(s) {
    const badgeMap = { "badge-CP": s.cp, "badge-Call": s.call, "badge-IR": s.ir, "badge-SR": s.sr, "badge-Drop": s.drop, "badge-Camp": s.camp };
    for (let id in badgeMap) {
        if (document.getElementById(id)) document.getElementById(id).innerText = badgeMap[id] || 0;
    }

    if (document.getElementById('displayTarget')) document.getElementById('displayTarget').innerText = s.target;
    if (document.getElementById('displayActual')) document.getElementById('displayActual').innerText = s.total;

    const balanceEl = document.getElementById('displayBalance');
    if (balanceEl) {
        const balance = s.total - s.target;
        balanceEl.innerText = balance;
        balanceEl.style.color = balance < 0 ? "#dc3545" : (balance > 0 ? "#28a745" : "#ff9800");
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateTodayUI ‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
const percent = s.target > 0 ? Math.round((s.total / s.target) * 100) : 0;
    const bar = document.getElementById('goalProgress');
    
    if (bar) {
        // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡∏ó‡∏∞‡∏•‡∏∏‡∏à‡∏≠)
        bar.style.width = Math.min(100, percent) + '%';
        
        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô 105%)
        bar.innerText = percent + '%';
        
        // 3. ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ (Logic: ‡πÅ‡∏î‡∏á -> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á -> ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
        if (percent <= 20) {
            // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å: ‡∏™‡∏µ‡πÅ‡∏î‡∏á
            bar.style.backgroundColor = "#dc3545"; 
            bar.style.color = "white";
        } else if (percent < 100) {
            // ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏™‡πâ‡∏° (‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô image_8c18d9.png)
            bar.style.backgroundColor = "#ffc107"; 
            bar.style.color = "black";
        } else {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            bar.style.backgroundColor = "#28a745"; 
            bar.style.color = "white";
        }

        // ‡∏•‡∏ö Class ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Bootstrap ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        bar.className = "progress-bar"; 
    }
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á Dashboard (‡πÄ‡∏ô‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
function renderDashTable(groups) {
    const keys = Object.keys(groups).sort().reverse();
    const tbody = document.getElementById('dashTableBody');
    const tableHeader = document.querySelector('#tab-dash thead');
    if (!tbody || !tableHeader) return;

    tableHeader.innerHTML = `<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th class="text-warning">CP</th><th>Call</th><th>IR</th><th>SR</th><th>Drop</th><th>Camp</th><th class="table-primary">Actual</th><th>Target</th><th>%</th></tr>`;

    if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
    }

    tbody.innerHTML = keys.map(k => {
        const g = groups[k];
        const pct = g.target > 0 ? Math.round((g.total / g.target) * 100) : 0;
        return `<tr><td class="small fw-bold">${k}</td><td>${g.cp}</td><td>${g.call}</td><td>${g.ir}</td><td>${g.sr}</td><td>${g.drop}</td><td>${g.camp}</td><td class="table-primary fw-bold">${g.total}</td><td>${g.target}</td><td class="fw-bold ${pct >= 100 ? 'text-success' : 'text-danger'}">${pct}%</td></tr>`;
    }).join('');
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á Dashboard (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Filter)
function renderDashTable(groups) {
    const keys = Object.keys(groups).sort().reverse(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    const tbody = document.getElementById('dashTableBody');
    const tableHeader = document.querySelector('#tab-dash thead'); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard
    
    if (!tbody || !tableHeader) return;

    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    tableHeader.innerHTML = `
        <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th style="color: #ff9800;">CP</th>
            <th>Call</th>
            <th>IR</th>
            <th>SR</th>
            <th>Drop</th>
            <th>Camp</th>
            <th class="table-primary">Actual</th>
            <th>Target</th>
            <th>%</th>
        </tr>
    `;

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Filter ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
    }

    // 3. ‡∏ß‡∏≤‡∏î‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Dynamic ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß)
    tbody.innerHTML = keys.map(k => {
        const g = groups[k];
        const pct = g.target > 0 ? Math.round((g.total / g.target) * 100) : 0;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
        const pctColor = pct >= 100 ? 'text-success' : (pct > 0 ? 'text-warning' : 'text-danger');

        return `
            <tr>
                <td class="fw-bold small">${k}</td>
                <td>${g.cp || 0}</td>
                <td>${g.call || 0}</td>
                <td>${g.ir || 0}</td>
                <td>${g.sr || 0}</td>
                <td>${g.drop || 0}</td>
                <td>${g.camp || 0}</td>
                <td class="table-primary fw-bold" style="background-color: #e3f2fd !important;">${g.total}</td>
                <td class="text-muted fw-bold">${g.target}</td>
                <td class="${pctColor} fw-bold">${pct}%</td>
            </tr>
        `;
    }).join('');
}

    // --- 7. UI HELPERS ---
    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-completely'));
        document.getElementById('tab-'+t).classList.remove('hidden-completely');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
        document.getElementById('nav-'+t).classList.add('active-btn');
        if(t === 'dash') processDashboard();
    }

    function toggleHistoryVisibility() {
        document.getElementById('historyContent').classList.toggle('hidden-completely');
    }

 function updateHistory() {
    const historyBody = document.getElementById('historyBody');
    if (!historyBody || typeof allData === 'undefined') return;

    // 1. ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    const now = new Date();
    const todayStr = now.toLocaleDateString('en-CA'); 

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    const history = allData.filter(d => {
        if (!d[0]) return false;
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà YYYY-MM-DD ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å
        const rowDateStr = new Date(d[0]).toLocaleDateString('en-CA');
        return rowDateStr === todayStr && d[1] === currentUser;
    }).reverse(); 

    if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    historyBody.innerHTML = history.map(d => {
        const dateObj = new Date(d[0]);
        const time = isNaN(dateObj) ? "--:--" : dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return `
            <tr>
                <td class="text-secondary small">${time} ‡∏ô.</td>
                <td class="fw-bold">${d[3] || '-'}</td>
                <td><span class="badge bg-light text-dark border">${d[2]}</span></td>
            </tr>
        `;
    }).join('');
}
processDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞ Dashboard
updateHistory();    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°

    setInterval(() => {
        const now = new Date();
        document.getElementById('bigClock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
        document.getElementById('todayDateLabel').innerText = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long' });
    }, 1000);

    function changeChartType(t) {
        currentChartType = t;
        document.getElementById('btn-bar').classList.toggle('active', t==='bar');
        document.getElementById('btn-line').classList.toggle('active', t==='line');
        processDashboard();
    }
 function parseCPData() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á
    const val4G = document.getElementById('cpInput4G').value.trim();
    const val5G = document.getElementById('cpInput5G').value.trim();
    const valAddr = document.getElementById('cpInputAddr').value.trim();

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4G/5G)
    const cleanLines = (text) => text.split('\n').map(l => l.trim()).filter(line => line.length > 0);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G ---
    if (val4G) {
        const lines4G = cleanLines(val4G);
        if (lines4G.length >= 2) document.getElementById('td-imsi').innerText = lines4G[1];
        if (lines4G.length >= 5) {
            document.getElementById('td-4gcell').innerText = `${lines4G[0]} ${lines4G[4]} ${lines4G[2]}`;
        }
        if (lines4G.length >= 7) document.getElementById('td-4grsrp').innerText = lines4G[6];
        if (lines4G.length >= 8) document.getElementById('td-4grsrq').innerText = lines4G[7];
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G ---
    if (val5G) {
        const lines5G = cleanLines(val5G);
        // IMSI: ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á 4G ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á 5G ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2
        const currentIMSI = document.getElementById('td-imsi').innerText;
        if (lines5G.length >= 2 && (currentIMSI === "-" || currentIMSI === "")) {
            document.getElementById('td-imsi').innerText = lines5G[1];
        }
        if (lines5G.length >= 5) {
            document.getElementById('td-5gcell').innerText = `${lines5G[0]} ${lines5G[4]} ${lines5G[2]}`;
        }
        if (lines5G.length >= 9) document.getElementById('td-5grsrp').innerText = lines5G[8];
        if (lines5G.length >= 10) document.getElementById('td-5gsinr').innerText = lines5G[9];
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Address ---
    if (valAddr) {
        // ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Index ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á)
        const lines = valAddr.split('\n').map(l => l.trim());
        let addr = { no: "-", bld: "-", soi: "-", rd: "-", tmb: "-", amp: "-", prv: "-", ldm: "-" };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        const findValue = (startIndex) => {
            for (let i = 1; i <= 3; i++) {
                let nextLine = lines[startIndex + i] ? lines[startIndex + i].trim() : "";
                if (nextLine !== "" && !nextLine.includes(":") && !nextLine.includes("‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")) {
                    return nextLine;
                } else if (nextLine.includes(":") || nextLine.includes("‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")) {
                    break;
                }
            }
            return "-";
        };

        lines.forEach((line, index) => {
            if (line.includes(":")) {
                const parts = line.split(":");
                const label = parts[0].trim().toLowerCase();
                let val = parts[1] ? parts[1].trim() : "";

                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á : ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á/0/- ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                if (val === "" || val === "-" || val === "0" || val === "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
                    val = findValue(index);
                }

                if (label.includes("address no")) addr.no = val;
                if (label.includes("location/building")) addr.bld = val;
                if (label.includes("soi")) addr.soi = val;
                if (label.includes("road")) addr.rd = val;
                if (label.includes("tumbol")) addr.tmb = val;
                if (label.includes("amphur")) addr.amp = val;
                if (label.includes("province")) addr.prv = val;
                if (label.includes("‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï")) addr.ldm = val;
            }
        });

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Formatted Address
        const formatted = [
            (addr.no !== "-" ? addr.no : "-"),
            (addr.bld !== "-" && addr.bld !== "" && addr.bld !== "0" ? "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ " + addr.bld : ""),
            "‡∏ã." + (addr.soi !== "-" ? addr.soi : "-"),
            "‡∏ñ." + (addr.rd !== "-" ? addr.rd : "-"),
            "‡∏ï." + (addr.tmb !== "-" ? addr.tmb : "-"),
            "‡∏≠." + (addr.amp !== "-" ? addr.amp : "-"),
            "‡∏à." + (addr.prv !== "-" ? addr.prv : "-"),
            (addr.ldm !== "-" ? "(‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: " + addr.ldm + ")" : "(‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: -)")
        ].filter(x => x !== "").join(" ");

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        const targetCell = document.getElementById('td-address');
        if (targetCell) {
            targetCell.innerText = formatted;
        }
    }

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏î Sync/Login ---
    const now = new Date();
    const timeString = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH', { hour12: false }) + ' ‡∏ô.';
    
    const syncTimeSpan = document.getElementById('lastSyncTime');
    const syncTimeDiv = document.getElementById('syncTimeSection');
    
    if (syncTimeSpan) {
        syncTimeSpan.innerText = timeString;
    }
    if (syncTimeDiv) {
        syncTimeDiv.classList.remove('d-none'); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î Sync
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    const summary = document.getElementById('cpSummarySection');
    if (summary) summary.classList.remove('d-none');

} // ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parseCPData ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

// 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Interval ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å
let autoSyncInterval = null;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
function runAlwaysOnSync() {
    parseCPData(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ

    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
    const dateStr = now.toLocaleDateString('th-TH');
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    const display = document.getElementById('autoSyncTime');
    if (display) {
        display.innerText = `${dateStr} ${timeStr}`;
    }
}

// ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
window.addEventListener('load', () => {
    runAlwaysOnSync(); // ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (!autoSyncInterval) {
        autoSyncInterval = setInterval(runAlwaysOnSync, 60000); // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ Sync ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
function runSyncProcess() {
    // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    parseCPData(); // ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
    const dateStr = now.toLocaleDateString('th-TH');
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà Navbar ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    const display = document.getElementById('autoSyncTime');
    if (display) {
        display.innerText = `${dateStr} ${timeStr}`;
    }
}// <--- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

// ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
window.addEventListener('load', () => {
    runSyncProcess();
    setInterval(runSyncProcess, 60000); // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
});


function clearCP() {
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Textarea ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const inputs = ['cpInput4G', 'cpInput5G', 'cpInputAddr'];
    inputs.forEach(id => {
        const inputEl = document.getElementById(id);
        if (inputEl) inputEl.value = "";
    });

    // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (class .cp-value-custom)
    document.querySelectorAll('.cp-value-custom').forEach(td => {
        td.innerText = "-";
    });

    // 3. ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    const summarySection = document.getElementById('cpSummarySection');
    if (summarySection) summarySection.classList.add('d-none');
    
    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    Swal.fire({
        title: '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        icon: 'success',
        timer: 1500, // ‡πÅ‡∏™‡∏î‡∏á 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
        showConfirmButton: false, // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏Å‡∏•‡∏á
        position: 'center' // ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    });

    console.log("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Auto Sync ‡πÉ‡∏ô Navbar ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)");
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Copy Table ---
function copyCPTable() {
    const table = document.getElementById('cpTable');
    if (!table) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        return;
    }

    try {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Range ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const range = document.createRange();
        range.selectNode(table);
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
        const successful = document.execCommand('copy');
        
        // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏´‡∏•‡∏±‡∏á‡∏Å‡πä‡∏≠‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à
        selection.removeAllRanges();

        if (successful) {
            Swal.fire({
                icon: 'success',
                title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                text: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Line ‡∏´‡∏£‡∏∑‡∏≠ Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                timer: 1500,
                showConfirmButton: false
            });
        }
    } catch (err) {
        console.error('Copy failed', err);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
    }
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Actual / Target / Badges) ---
function updateHomeStats() {
    // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const myTodayData = allData.filter(d => {
        const rowDate = new Date(d[0]).toISOString().split('T')[0];
        return rowDate === todayStr && d[1] === currentUser;
    });

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Target): ‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const myPlan = allPlans.find(p => {
        const planDate = new Date(p[0]).toISOString().split('T')[0];
        return planDate === todayStr && p[1] === currentUser;
    });

    const target = myPlan ? parseInt(myPlan[3]) : 0;
    const actual = myTodayData.length;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Actual / Target ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    document.getElementById('displayTarget').innerText = target;
    document.getElementById('displayActual').innerText = actual;
    document.getElementById('displayBalance').innerText = actual - target;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Badges)
    const badgeMap = { 
        "CP No.": "badge-CP", 
        "Call IN": "badge-Call", 
        "IR": "badge-IR", 
        "SR": "badge-SR", 
        "Drop Call": "badge-Drop", 
        "Campaign": "badge-Camp" 
    };

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Badge ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πà‡∏≠‡∏ô
    Object.values(badgeMap).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = "0";
    });

    // ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Badge
    myTodayData.forEach(d => {
        const category = d[2];
        const elementId = badgeMap[category];
        if (elementId) {
            const el = document.getElementById(elementId);
            el.innerText = parseInt(el.innerText) + 1;
        }
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ---
function updateHistory() {
    // 1. ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏∑‡∏î)
    const todayStr = new Date().toLocaleDateString('en-CA');
    const historyBody = document.getElementById('historyBody');
    
    if (!historyBody) return;

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const history = allData.filter(d => {
        const rowDate = new Date(d[0]).toLocaleDateString('en-CA');
        return rowDate === todayStr && d[1] === currentUser;
    }).reverse();

    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }

    // 4. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    historyBody.innerHTML = history.map(d => {
        const time = new Date(d[0]).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return `
            <tr>
                <td class="text-secondary">${time} ‡∏ô.</td>
                <td class="fw-bold">${d[3]}</td> <td><span class="badge bg-light text-dark border">${d[2]}</span></td> </tr>
        `;
    }).join('');
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô (Digital Clock)
function updateClock() {
    const now = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    const dateStr = now.toLocaleDateString('th-TH', options);
    document.getElementById('displayDate').innerText = dateStr;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
    const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
    document.getElementById('displayTime').innerText = timeStr;
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Clock ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(updateClock, 1000);

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderPlanTable() {
    const tbody = document.getElementById('planTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á currentUser
    const myPlans = allPlans.filter(p => p[1] === currentUser)
                            .sort((a, b) => new Date(b[0]) - new Date(a[0])); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

    myPlans.forEach((p, index) => {
        const dateStr = new Date(p[0]).toLocaleDateString('th-TH', { 
            year: 'numeric', month: 'short', day: 'numeric' 
        });
        
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td class="fw-bold text-primary">${p[3]}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deletePlan('${p[0]}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
async function saveNewPlan() {
    const date = document.getElementById('planDate').value;
    const target = document.getElementById('planTarget').value;

    if (!date || !target) {
        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' });
        return;
    }

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô...', didOpen: () => { Swal.showLoading(); } });

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'savePlan', // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô GS ‡∏°‡∏µ action ‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
                user: currentUser,
                date: date,
                target: target
            })
        });

        const result = await response.json();
        if (result.status === "success") {
            Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
            document.getElementById('planTarget').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
            await initData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            renderPlanTable(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            processDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
        }
    } catch (e) {
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }
}

</script>
</body>
</html>