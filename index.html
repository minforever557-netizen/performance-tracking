<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V75 - Final Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --deep-orange: #e65100;
            --bright-orange: #ff8c00;
            --text-main: #2d3436;
            --bg-liquid: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
        }

        body.dark-mode { 
            --glass-bg: rgba(40, 40, 40, 0.98); 
            --bg-liquid: linear-gradient(to top, #0f0f0f 0%, #1a1a1a 100%); 
            --text-main: #ffffff;
        }

        body { font-family: 'Prompt', sans-serif; background: var(--bg-liquid); min-height: 100vh; color: var(--text-main); transition: 0.3s; }

        .glass-card { 
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 12px;
        }

        /* üçä Progress Bar System */
        .progress-wrapper { background: rgba(0,0,0,0.05); height: 26px; border-radius: 13px; overflow: hidden; position: relative; }
        .progress-bar-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, #ff8c00, #ffb347, #ff8c00);
            background-size: 200% 100%; animation: shimmer 2s infinite linear;
            transition: width 1s ease; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 0.85rem;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* üìä Dashboard Filters */
        .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .filter-box { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 5px; flex: 1; min-width: 100px; }
        .filter-label { font-size: 0.65rem; font-weight: 600; color: #888; margin-left: 5px; }
        .filter-box select { border: none; width: 100%; font-size: 0.8rem; font-weight: 600; outline: none; background: transparent; }

        /* Status Colors */
        .status-red { color: #d32f2f !important; }
        .status-yellow { color: #fbc02d !important; }
        .status-green { color: #388e3c !important; }
        
        #bigClock { color: var(--deep-orange); font-size: 2.2rem; font-weight: 700; }
        #displayDateText { color: var(--deep-orange); font-weight: 600; }

        .nav-btn.active-btn { background: var(--bright-orange); color: white; border-radius: 12px; }
        .hidden-completely { display: none !important; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .sync-label { font-size: 0.65rem; font-weight: bold; color: #666; margin-top: 4px; }
    </style>
</head>
<body>

<div id="loginSection" style="position:fixed; width:100%; height:100%; z-index:9999; background:var(--bg-liquid); display:flex; align-items:center; justify-content:center;">
    <div id="loadingOverlay" class="loader-overlay hidden-completely">
        <div class="spinner-border text-warning mb-3"></div>
        <h5 class="fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h5>
    </div>
    <div class="glass-card text-center" style="width:90%; max-width:350px;">
        <h3 class="fw-bold mb-4" style="color:var(--deep-orange)">üçä Performance</h3>
        <input type="text" id="user" class="form-control rounded-pill mb-3" placeholder="Username">
        <input type="password" id="pass" class="form-control rounded-pill mb-4" placeholder="Password">
        <button onclick="login()" class="btn btn-warning w-100 fw-bold text-white rounded-pill py-2 shadow">LOGIN</button>
    </div>
</div>

<div id="mainSection" class="hidden-completely">
    <nav class="navbar mb-2 p-2 glass-card mx-2 mt-2">
        <div class="container d-flex justify-content-between p-0 align-items-center">
            <span class="fw-bold text-orange">üçä V.75 MASTER</span>
            <div class="d-flex align-items-center gap-3">
                <i class="fa-solid fa-circle-half-stroke" onclick="toggleDarkMode()" style="cursor:pointer"></i>
                <div class="text-end small"><b><span id="empName"></span></b> | <a href="#" onclick="logout()" class="text-danger">‡∏≠‡∏≠‡∏Å</a></div>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex gap-1 mb-3 p-1 glass-card" style="border-radius: 15px;">
            <button id="nav-record" class="btn nav-btn active-btn flex-fill" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="nav-dash" class="btn nav-btn flex-fill" onclick="showTab('dash')">‡∏™‡∏£‡∏∏‡∏õ</button>
            <button id="nav-assign" class="btn nav-btn flex-fill" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="displayDateText">üìÖ -</div>
                    <div class="text-end">
                        <button class="btn btn-sm btn-light border rounded-pill px-3 shadow-sm" onclick="manualRefresh()">Sync</button>
                        <div class="sync-label">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span class="lastSyncTime">00:00:00</span></div>
                    </div>
                </div>
                <div id="bigClock">00:00:00</div>
                <div class="progress-wrapper my-3"><div id="goalProgress" class="progress-bar-fill">0%</div></div>
                <div class="row g-2 mb-2">
                    <div class="col-4"><div class="stat-item p-1 border rounded-3 bg-white">Target<br><b id="displayTarget">0</b></div></div>
                    <div class="col-4"><div class="stat-item p-1 border rounded-3 bg-white">Actual<br><b id="displayActual" class="text-primary">0</b></div></div>
                    <div class="col-4"><div class="stat-item p-1 border rounded-3 bg-white">Balance<br><b id="displayBalance">0</b></div></div>
                </div>
                <button class="btn btn-sm btn-outline-warning w-100 rounded-pill" onclick="toggleHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏™‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <div id="historyPanel" class="hidden-completely mt-2 glass-card p-1 text-start" style="max-height: 150px; overflow-y: auto;">
                    <table class="table table-sm mb-0" style="font-size: 0.7rem;"><tbody id="historyTableBody"></tbody></table>
                </div>
            </div>

            <div class="row g-2 mt-2">
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">CP</div><input type="text" class="form-control form-control-sm cat-input" data-cat="CP No." placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">Call</div><input type="text" class="form-control form-control-sm cat-input" data-cat="Call IN" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">IR</div><input type="text" class="form-control form-control-sm cat-input" data-cat="IR" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">SR</div><input type="text" class="form-control form-control-sm cat-input" data-cat="SR" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">Drop</div><input type="text" class="form-control form-control-sm cat-input" data-cat="Drop Call" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
                <div class="col-4"><div class="glass-card p-2 text-center small"><div class="fw-bold mb-1">Camp</div><input type="text" class="form-control form-control-sm cat-input" data-cat="Campaign" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Case ID"></div></div>
            </div>
            <button onclick="saveWork()" class="btn btn-warning w-100 text-white fw-bold py-3 mt-3 rounded-pill shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-chart-column"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h6>
                    <div class="text-end">
                        <button class="btn btn-xs btn-outline-warning rounded-pill px-2" onclick="manualRefresh()" style="font-size: 0.7rem;">Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <div class="sync-label" style="font-size: 0.55rem;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <span class="lastSyncTime">00:00:00</span></div>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-box"><div class="filter-label">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</div><select id="viewType" onchange="updateDashFilterLogic()"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option><option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select></div>
                    <div class="filter-box" id="boxYear"><div class="filter-label">‡∏õ‡∏µ</div><select id="selYear" multiple onchange="updateMonthList()"></select></div>
                    <div class="filter-box hidden-completely" id="boxQuarter"><div class="filter-label">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</div><select id="selQuarter" multiple onchange="processDashboard()"><option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option></select></div>
                    <div class="filter-box" id="boxMonth"><div class="filter-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><select id="selMonth" multiple onchange="updateDayList()"></select></div>
                    <div class="filter-box" id="boxDay"><div class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><select id="selDay" multiple onchange="processDashboard()"></select></div>
                </div>
                
                <div class="d-flex justify-content-between mb-2">
                    <div class="btn-group btn-group-sm rounded-pill border overflow-hidden">
                        <button id="btn-bar" class="btn btn-light px-3 active" onclick="changeChartType('bar')">Bar</button>
                        <button id="btn-line" class="btn btn-light px-3" onclick="changeChartType('line')">Line</button>
                    </div>
                </div>
                <div style="height: 250px;"><canvas id="perfChart"></canvas></div>
                <div class="table-responsive mt-3"><table class="table table-sm text-center small" style="font-size: 0.75rem;"><thead class="table-light"><tr><th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th>CP</th><th>Call</th><th>Actual</th><th>Target</th></tr></thead><tbody id="dashTableBody"></tbody></table></div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
            <div class="glass-card">
                <h6 class="fw-bold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</h6>
                <div class="row g-2 mb-3 border-bottom pb-3">
                    <div class="col-5"><input type="date" id="planDate" class="form-control form-control-sm"></div>
                    <div class="col-3"><select id="planType" class="form-select form-select-sm"><option value="72">72</option><option value="36">36</option></select></div>
                    <div class="col-4"><button onclick="savePlan('save')" class="btn btn-warning btn-sm w-100 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
                </div>
                <select id="assignMonthFilter" class="form-select form-select-sm rounded-pill mb-3" onchange="renderPlanTable()">
                    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                </select>
                <div class="table-responsive"><table class="table table-sm text-center small"><thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="planTableBody"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    let currentUser = "", allData = [], allPlans = [], chartInstance = null, currentChartType = 'bar';

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); processDashboard(); }
    function toggleHistory() { document.getElementById('historyPanel').classList.toggle('hidden-completely'); }

    async function login() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return;
        document.getElementById('loadingOverlay').classList.remove('hidden-completely');
        const res = await (await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`)).json();
        if (res.status === "success") {
            currentUser = res.name; document.getElementById('empName').innerText = res.name;
            document.getElementById('loginSection').classList.add('hidden-completely');
            document.getElementById('mainSection').classList.remove('hidden-completely');
            await refreshView(); initYearFilter();
        } else { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        document.getElementById('loadingOverlay').classList.add('hidden-completely');
    }

    async function manualRefresh() {
        document.getElementById('loadingOverlay').classList.remove('hidden-completely');
        await refreshView();
        processDashboard();
        document.getElementById('loadingOverlay').classList.add('hidden-completely');
    }

    async function refreshView() {
        try {
            const res = await (await fetch(SCRIPT_URL)).json();
            allData = res.data.slice(1); allPlans = res.plans.slice(1);
            const todayStr = new Date().toISOString().split('T')[0];
            const myToday = allData.filter(d => d[0].split('T')[0] === todayStr && d[1] === currentUser);
            
            const plan = allPlans.find(p => p[0].split('T')[0] === todayStr && p[1] === currentUser);
            const target = plan ? parseInt(plan[3]) : 0;
            const actual = myToday.length;
            const diff = actual - target;

            const pct = target > 0 ? Math.round((actual / target) * 100) : 0;
            document.getElementById('goalProgress').style.width = Math.min(pct, 100) + "%";
            document.getElementById('goalProgress').innerText = pct + "%";

            const balEl = document.getElementById('displayBalance');
            balEl.innerText = diff;
            balEl.className = diff < 0 ? 'status-red' : (diff === 0 ? 'status-yellow' : 'status-green');

            document.getElementById('displayTarget').innerText = target;
            document.getElementById('displayActual').innerText = actual;
            document.getElementById('displayDateText').innerText = "üìÖ " + new Date().toLocaleDateString('th-TH', {day:'numeric', month:'long'});
            
            const nowTime = new Date().toLocaleTimeString('th-TH');
            document.querySelectorAll('.lastSyncTime').forEach(el => el.innerText = nowTime);

            document.getElementById('historyTableBody').innerHTML = myToday.reverse().map(h => `
                <tr><td>${new Date(h[0]).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</td>
                <td class="text-orange fw-bold">${h[2]}</td><td>${h[3]}</td></tr>
            `).join('');
            renderPlanTable();
        } catch(e) {}
    }

    /* üìä Dashboard Core Logic */
    function initYearFilter() {
        const years = [...new Set(allData.map(d => d[0].split('-')[0]))].sort((a,b)=>b-a);
        if(!years.length) years.push(new Date().getFullYear().toString());
        document.getElementById('selYear').innerHTML = years.map(y => `<option value="${y}" selected>${y}</option>`).join('');
        updateDashFilterLogic();
    }

    function updateDashFilterLogic() {
        const type = document.getElementById('viewType').value;
        document.getElementById('boxMonth').classList.toggle('hidden-completely', type === 'yearly');
        document.getElementById('boxQuarter').classList.toggle('hidden-completely', type !== 'quarterly');
        document.getElementById('boxDay').classList.toggle('hidden-completely', type !== 'daily');
        updateMonthList();
    }

    function updateMonthList() {
        const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        document.getElementById('selMonth').innerHTML = months.map((m, i) => `<option value="${i+1}" selected>${m}</option>`).join('');
        updateDayList();
    }

    function updateDayList() {
        const type = document.getElementById('viewType').value;
        if(type !== 'daily') { processDashboard(); return; }
        const years = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const months = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value.padStart(2, '0'));
        let days = [...new Set(allData.filter(d => years.includes(d[0].split('-')[0]) && months.includes(d[0].split('-')[1])).map(d => d[0].split('T')[0]))].sort();
        document.getElementById('selDay').innerHTML = days.map(d => `<option value="${d}" selected>${d}</option>`).join('');
        processDashboard();
    }

    function processDashboard() {
        const type = document.getElementById('viewType').value;
        const years = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const months = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value.padStart(2, '0'));
        const quarters = Array.from(document.getElementById('selQuarter').selectedOptions).map(o => o.value);
        const days = Array.from(document.getElementById('selDay').selectedOptions).map(o => o.value);

        let groups = {};
        // ‡∏£‡∏ß‡∏° Actual
        allData.filter(d => d[1] === currentUser).forEach(d => {
            const dt = d[0].split('T')[0];
            const [y, m] = dt.split('-');
            const q = Math.ceil(parseInt(m)/3).toString();
            let key = "";
            if(type==='daily' && days.includes(dt)) key = dt;
            else if(type==='monthly' && years.includes(y) && months.includes(m)) key = `${y}-${m}`;
            else if(type==='yearly' && years.includes(y)) key = y;
            else if(type==='quarterly' && years.includes(y) && quarters.includes(q)) key = `Q${q}-${y}`;
            if(key) {
                if(!groups[key]) groups[key] = {act:0, target:0, cp:0, call:0};
                groups[key].act++;
                if(d[2]==="CP No.") groups[key].cp++; else if(d[2]==="Call IN") groups[key].call++;
            }
        });
        // ‡∏£‡∏ß‡∏° Target
        allPlans.filter(p => p[1] === currentUser).forEach(p => {
            const dt = p[0].split('T')[0];
            const [y, m] = dt.split('-');
            const q = Math.ceil(parseInt(m)/3).toString();
            let key = "";
            if(type==='daily' && days.includes(dt)) key = dt;
            else if(type==='monthly' && years.includes(y) && months.includes(m)) key = `${y}-${m}`;
            else if(type==='yearly' && years.includes(y)) key = y;
            else if(type==='quarterly' && years.includes(y) && quarters.includes(q)) key = `Q${q}-${y}`;
            if(key && groups[key]) groups[key].target += parseInt(p[3] || 0);
        });

        const labels = Object.keys(groups).sort();
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('perfChart'), {
            type: currentChartType,
            plugins: [ChartDataLabels],
            data: { 
                labels, 
                datasets: [
                    { label: 'Actual', data: labels.map(l => groups[l].act), backgroundColor: 'rgba(255, 140, 0, 0.7)', borderColor: '#e65100', datalabels: { align: 'end', anchor: 'end', color: 'orange', font: { weight: 'bold' } } },
                    { label: 'Target', data: labels.map(l => groups[l].target), backgroundColor: 'rgba(100, 100, 100, 0.2)', borderColor: '#666', type: 'line', datalabels: { align: 'top', color: '#666' } }
                ] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
        document.getElementById('dashTableBody').innerHTML = labels.reverse().map(l => `<tr><td>${l}</td><td>${groups[l].cp}</td><td>${groups[l].call}</td><td class="fw-bold text-orange">${groups[l].act}</td><td class="text-muted">${groups[l].target}</td></tr>`).join('');
    }

    function renderPlanTable() {
        const monthFilter = document.getElementById('assignMonthFilter').value;
        let f = allPlans.filter(p => p[1] === currentUser);
        if(monthFilter !== 'all') f = f.filter(p => (new Date(p[0]).getMonth() + 1).toString() === monthFilter);
        document.getElementById('planTableBody').innerHTML = f.sort((a,b)=>new Date(b[0])-new Date(a[0])).map(p => `<tr><td>${p[0].split('T')[0]}</td><td><b>${p[3]}</b></td><td><i class="fa-solid fa-trash text-danger" onclick="savePlan('delete','${p[0].split('T')[0]}')" style="cursor:pointer"></i></td></tr>`).join('');
    }

    function showTab(t) { 
        document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden-completely')); 
        document.getElementById('tab-'+t).classList.remove('hidden-completely'); 
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn')); 
        document.getElementById('nav-'+t).classList.add('active-btn');
        if(t==='dash') processDashboard();
    }

    async function saveWork() {
        const entries = []; 
        document.querySelectorAll('.cat-input').forEach(i => { if(i.value.trim()) i.value.split(',').forEach(id => entries.push({category: i.dataset.cat, caseId: id.trim()})); });
        if(!entries.length) return;
        Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'saveData', employee:currentUser, entries}) });
        document.querySelectorAll('.cat-input').forEach(i => i.value = "");
        await refreshView(); Swal.close();
    }

    async function savePlan(a, d) { await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'savePlan', subAction: a, date: d || document.getElementById('planDate').value, employee: currentUser, target: document.getElementById('planType').value})}); refreshView(); }
    function changeChartType(t) { currentChartType = t; processDashboard(); }
    function logout() { location.reload(); }
    setInterval(() => { document.getElementById('bigClock').innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);
</script>
</body>
</html>