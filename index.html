<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V.92 - Hybrid Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <style>
        :root { 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --deep-orange: #e65100;
            --bright-orange: #ff8c00;
            --bg-liquid: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
        }

        /* Base UI */
        body { font-family: 'Prompt', sans-serif; background: var(--bg-liquid); min-height: 100vh; color: #2d3436; margin: 0; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 15px; }
        .hidden-completely { display: none !important; }

        /* Navigation */
        .nav-btn { border: none; background: none; color: #636e72; font-weight: 600; padding: 10px; transition: 0.3s; flex: 1; font-size: 0.85rem; border-radius: 12px; }
        .nav-btn.active-btn { background: var(--bright-orange); color: white; box-shadow: 0 4px 10px rgba(255,140,0,0.3); }

        /* Dashboard Filter Grid */
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; align-items: stretch; width: 100%; }
        .filter-box { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; display: flex; flex-direction: column; }
        .filter-box select { width: 100%; border: 1px solid #ccc; border-radius: 5px; padding: 4px; margin-top: 5px; flex-grow: 1; font-size: 0.8rem; }
        .filter-label { font-weight: bold; font-size: 0.8rem; color: #555; }

        /* Progress & Badges */
        .progress-wrapper { background: rgba(0,0,0,0.05); height: 26px; border-radius: 13px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8c00, #ffb347, #ff8c00); transition: width 1s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
        .count-circle { background: linear-gradient(135deg, #ff9100, #ffea00); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; margin-right: 4px; }

        /* CP Detail Table */
        .cp-table-render { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; background: white; border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .cp-table-render td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .cp-label-custom { background-color: #fff8e1; font-weight: 600; color: var(--deep-orange); width: 40%; border-right: 1px solid #f0f0f0; }
        .cp-value-custom { background-color: #ffffff; color: #333; }
        .cp-section-title { background: linear-gradient(90deg, var(--bright-orange), var(--deep-orange)); color: white; font-weight: bold; padding: 8px 15px; font-size: 0.9rem; }

        /* Loader */
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--bright-orange); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏•‡∏∞ Responsive --- */

            /* 1. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Container ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
                .container {
                    max-width: 100% !important; 
                    width: 100% !important;
                    padding: 0 15px !important;
                }

            /* 2. ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö Tab ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
                .glass-card.d-flex.gap-1 {
                    display: flex !important;
                    width: 100%;
                    justify-content: space-between;
                }

                .nav-btn {
                    flex: 1; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡∏´‡∏≤‡∏£ 4 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) */
                    text-align: center;
                    padding: 12px 5px;
                    font-size: 0.9rem;
                    border-radius: 12px !important;
                }

            /* 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Tab Content) ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
                .tab-content, .glass-card {
                    width: 100% !important;
                }

            /* 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ CP ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
                .table-responsive {
                    width: 100%;
            overflow-x: auto; /* ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
}
    </style>
</head>
<body>

<section id="loginSection" style="position:fixed; inset:0; z-index:9999; background:var(--bg-liquid); display:flex; align-items:center; justify-content:center;">
    <div class="glass-card text-center shadow-lg" style="width:90%; max-width:350px;">
        <h3 class="fw-bold mb-4" style="color:var(--deep-orange)">üçä Performance</h3>
        <div id="loginInputs">
            <input type="text" id="user" class="form-control rounded-pill mb-3" placeholder="Username">
            <input type="password" id="pass" class="form-control rounded-pill mb-4" placeholder="Password">
            <button onclick="login()" class="btn btn-warning w-100 fw-bold text-white rounded-pill py-2 shadow-sm">LOGIN</button>
        </div>
        <div id="loginStatus" class="hidden-completely">
            <div class="loader-spinner"></div>
            <p class="mb-1 fw-bold text-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</p>
            <p id="targetUserDisplay" class="text-warning small"></p>
        </div>
    </div>
</section>

<main id="mainSection" class="hidden-completely">
<nav class="navbar glass-card m-2 p-2">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div style="flex: 1;">
            <span class="fw-bold" style="color:var(--bright-orange)">üçä PERFORMANCE V.92</span>
        </div>

        <div style="flex: 1;" class="text-center">
            <div id="currentDateTimeDisplay" style="line-height: 1.2;">
                <div id="displayDate" style="font-size: 11px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</div>
                <div id="displayTime" style="font-size: 18px; font-weight: bold; color: var(--bright-orange);">00:00:00</div>
            </div>
        </div>

        <div style="flex: 1;" class="text-end">
            <div class="small">
                <b id="empName">nuttawut thummajinda</b> | 
                <a href="#" onclick="location.reload()" class="text-danger text-decoration-none">‡∏≠‡∏≠‡∏Å</a>
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 2px;">
                <i class="fas fa-sync-alt fa-spin text-success"></i> 
                Auto Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="autoSyncTime">-</span>
            </div>
        </div>
    </div>
</nav>
    <div class="container">
        <div class="glass-card d-flex gap-1 p-1 mb-3" style="border-radius: 15px; overflow-x: auto;">
            <button id="nav-record" class="btn nav-btn active-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="nav-cp" class="btn nav-btn" onclick="showTab('cp')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î CP</button>
            <button id="nav-dash" class="btn nav-btn" onclick="showTab('dash')">‡∏™‡∏£‡∏∏‡∏õ</button>
            <button id="nav-assign" class="btn nav-btn" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>
        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center">
                <div class="progress-wrapper mb-3"><div id="goalProgress" class="progress-bar-fill">0%</div></div>
                <div class="row g-2 mb-4 border-bottom pb-3">
                <div class="col-4">Target<br><b id="displayTarget">0</b></div>
                <div class="col-4 text-primary">Actual<br><b id="displayActual">0</b></div>
                <div class="col-4">Balance<br><b id="displayBalance">0</b></div>
                </div>

                <div class="row g-3">
                    <div class="col-4 small"><span class="count-circle" id="badge-CP">0</span> CP<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="CP No." placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Call">0</span> Call<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Call IN" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-IR">0</span> IR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="IR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-SR">0</span> SR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="SR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Drop">0</span> Drop<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Drop Call" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Camp">0</span> Camp<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Campaign" placeholder="ID"></div>
                </div>
                
                <button onclick="saveWork()" class="btn btn-warning w-100 text-white fw-bold py-3 mt-4 rounded-pill shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold m-0 small"><i class="fa-solid fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistoryVisibility()">
                        <i class="fa-solid fa-eye"></i> ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
                    </button>
                </div>
                <div id="historyContent" class="hidden-completely">
                    <div class="table-responsive">
                        <table class="table table-sm" style="font-size: 0.75rem;">
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cp" class="tab-content">
    <div class="glass-card">
        <h6 class="fw-bold mb-3" style="color:var(--deep-orange)">
            <i class="fa-solid fa-bolt me-2"></i>Smart CP Splitter
        </h6>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="small fw-bold text-primary">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G (IMSI ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2 / Signal 7,8):</label>
                <textarea id="cpInput4G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-danger">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G (Signal ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 9,10):</label>
                <textarea id="cpInput5G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-success">3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address):</label>
                <textarea id="cpInputAddr" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà..." oninput="parseCPData()"></textarea>
            </div>
        </div>
        
        <div class="table-responsive">
    <table class="cp-table-render" id="cpTable">
        <thead>
            <tr><th colspan="2" class="cp-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)</th></tr>
        </thead>
        <tbody>
            <tr><td class="cp-label-custom">IMSI :</td><td id="td-imsi" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GCell Name:</td><td id="td-4gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4G Signal Strength :</td><td id="td-4grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GSignal Quality :</td><td id="td-4grsrq" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GCell Name:</td><td id="td-5gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5G Signal Strength :</td><td id="td-5grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GSignal Quality :</td><td id="td-5gsinr" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address) :</td><td id="td-address" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Remark :</td><td id="td-remark" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Arpu :</td><td id="td-arpu" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Service Year :</td><td id="td-service-year" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package :</td><td id="td-package" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package Remaining :</td><td id="td-package-remaining" class="cp-value-custom" contenteditable="true">-</td></tr>
        </tbody>
    </table>
</div>

        <div class="row g-2 mt-3">
            <div class="col-4">
                    <button class="btn btn-light w-100 rounded-pill border fw-bold" onclick="clearCP()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
                <div class="col-8">
                    <button class="btn btn-warning w-100 rounded-pill text-white fw-bold shadow" onclick="copyCPTable()">
                    <i class="fa-regular fa-copy me-2"></i>Copy Table
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-chart-line me-2"></i>Performance Summary</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning active" id="btn-bar" onclick="changeChartType('bar')">Bar</button>
                        <button class="btn btn-outline-warning" id="btn-line" onclick="changeChartType('line')">Line</button>
                    </div>
                </div>

                <div class="filter-row mb-3">
                    <div class="filter-box"><label class="filter-label">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="viewType" onchange="updateDashFilters()"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option></select></div>
                    <div class="filter-box"><label class="filter-label">‡∏õ‡∏µ</label><select id="selYear" onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="monthBox"><label class="filter-label" id="lblSub">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select id="selSub" multiple onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="dayBox"><label class="filter-label">‡∏ß‡∏±‡∏ô</label><select id="selDay" multiple onchange="processDashboard()"></select></div>
                </div>

                <div style="height: 350px;"><canvas id="perfChart"></canvas></div>
                
                <div class="table-responsive mt-3" style="max-height: 300px;">
                    <table class="table table-sm text-center small">
                        <thead class="table-light sticky-top">
                            <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>Actual</th><th>Target</th><th>%</th></tr>
                        </thead>
                        <tbody id="dashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
    <div class="glass-card mb-3">
        <h6 class="fw-bold mb-3" style="color:var(--deep-orange)">
            <i class="fa-solid fa-calendar-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </h6>
        <div class="row g-2">
            <div class="col-6">
                <label class="small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="planDate" class="form-control form-control-sm">
            </div>
            <div class="col-6">
                <label class="small fw-bold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target)</label>
                <input type="number" id="planTarget" class="form-control form-control-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
            </div>
            <div class="col-12 mt-3">
                <button onclick="saveNewPlan()" class="btn btn-primary w-100 rounded-pill">
                    <i class="fa-solid fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h6 class="fw-bold mb-3"><i class="fa-solid fa-list-check me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
        <div class="table-responsive">
            <table class="table table-sm text-center small">
                <thead class="table-light">
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>Target</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="planTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>
</main>


<script>
    // --- 1. CONFIG & GLOBALS ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    const MONTHS_TH = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    let currentUser = "", allData = [], allArchive = [], allPlans = [], chartInstance = null, currentChartType = 'bar';

    // --- 2. AUTH ---
    async function login() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return;
        document.getElementById('loginInputs').classList.add('hidden-completely');
        document.getElementById('loginStatus').classList.remove('hidden-completely');
        document.getElementById('targetUserDisplay').innerText = `User: ${u}`;
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.status === "success") {
                currentUser = data.name;
                document.getElementById('empName').innerText = currentUser;
                document.getElementById('loginSection').classList.add('hidden-completely');
                document.getElementById('mainSection').classList.remove('hidden-completely');
                initData();
                setInterval(initData, 60000);
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                document.getElementById('loginInputs').classList.remove('hidden-completely');
                document.getElementById('loginStatus').classList.add('hidden-completely');
            }
        } catch(e) { location.reload(); }
    }

    // --- 3. DATA ENGINE ---
async function initData() {
    try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();
        
        allData = json.data ? json.data.slice(1) : [];
        allArchive = json.archive || []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
        allPlans = json.plans ? json.plans.slice(1) : [];

        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô allArchive ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å setupFilters
        setupFilters(); 
        
        updateHomeStats();
        updateHistory();
        renderPlanTable();
        
        // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Dashboard
        processDashboard(); 
    } catch(e) { console.error("Sync Error:", e); }
}

// --- 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô) ---
let myChart = null;

// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ---
function renderChart(groups) {
    const canvas = document.getElementById('perfChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    const labels = Object.keys(groups).sort();
    const actualData = labels.map(k => groups[k].total);
    const targetData = labels.map(k => groups[k].target);

    // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≠‡∏ô)
    if (myChart) {
        myChart.destroy();
    }

myChart = new Chart(ctx, {
    type: typeof currentChartType !== 'undefined' ? currentChartType : 'bar',
    plugins: [ChartDataLabels], 
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Actual',
                data: actualData,
                backgroundColor: '#ffa500', 
                borderColor: '#ffa500',
                borderWidth: 1,
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold' },
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏° % ‡∏Ç‡∏≠‡∏á Target ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                    color: function(context) {
                        const index = context.dataIndex;
                        const actual = context.dataset.data[index];
                         const target = targetData[index];
                        const pct = target > 0 ? (actual / target) * 100 : 0;

                            // --- ‡πÑ‡∏•‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ‡∏ó‡∏∏‡∏Å 5% ---
                                if (pct <= 5)   return '#8B0000'; // ‡πÅ‡∏î‡∏á‡∏°‡∏∑‡∏î‡∏°‡∏≤‡∏Å (Dark Red)
                                if (pct <= 10)  return '#A52A2A'; // ‡πÅ‡∏î‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
                                if (pct <= 15)  return '#B22222'; // ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏•‡∏¥‡∏á
                                if (pct <= 20)  return '#DC3545'; // ‡πÅ‡∏î‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                                if (pct <= 25)  return '#E35D6A'; // ‡πÅ‡∏î‡∏á‡∏ä‡∏°‡∏û‡∏π
                                if (pct <= 30)  return '#EA868F'; // ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô
                                if (pct <= 35)  return '#F1AFB5'; // ‡πÅ‡∏î‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•
                                if (pct <= 40)  return '#F8D7DA'; // ‡πÅ‡∏î‡∏á‡∏à‡∏≤‡∏á‡∏°‡∏≤‡∏Å
                                if (pct <= 45)  return '#FF8C00'; // ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
                                if (pct <= 50)  return '#FD7E14'; // ‡∏™‡πâ‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                                if (pct <= 55)  return '#FFA500'; // ‡∏™‡πâ‡∏°‡∏ó‡∏≠‡∏á
                                if (pct <= 60)  return '#FFB347'; // ‡∏™‡πâ‡∏°‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•
                                if (pct <= 65)  return '#CC9A06'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏° (Gold)
                                if (pct <= 70)  return '#D4A017'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á
                                if (pct <= 75)  return '#E1B12C'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏°‡∏±‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏î
                                if (pct <= 80)  return '#F1C40F'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á
                                if (pct <= 85)  return '#F4D03F'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
                                if (pct <= 90)  return '#F7DC6F'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏à‡∏≤‡∏á
                                if (pct <= 95)  return '#D4EFDF'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å
                                if (pct < 100)  return '#A9DFBF'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå
    
                                return '#28A745'; // 100% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏¢‡∏≠‡∏î 104% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡∏µ‡πâ)
                        }
                }
            },
            {
                label: 'Target',
                data: targetData,
                type: 'line', 
                borderColor: '#ff6384',
                borderDash: [5, 5],
                fill: false,
                datalabels: {
                    display: false // ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô Target ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                }
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 30 } },
        plugins: {
            legend: { position: 'top' },
            datalabels: {
                display: true,
                formatter: (value) => value > 0 ? value : ''
            }
        },
        scales: { y: { beginAtZero: true } }
    }
});
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ)
function setupFilters() {
    const selYear = document.getElementById('selYear');
    const selDay = document.getElementById('selDay');
    if (!selYear || !selDay) return;

    // 1. ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á Data ‡πÅ‡∏•‡∏∞ Archive ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏õ‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ allArchive ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ß‡πà‡∏≤‡∏á
    const archiveForMap = (typeof allArchive !== 'undefined') ? allArchive : [];
    
    const allDates = [
        ...allData.map(d => new Date(d[0])),
        ...archiveForMap.map(d => new Date(d[0]))
    ];

    // ‡∏´‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
    let years = [...new Set(allDates.map(d => d.getFullYear()))]
                .filter(y => !isNaN(y))
                .sort((a, b) => b - a);

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const currentYear = new Date().getFullYear();
    if (years.length === 0) years = [currentYear];

    // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà
    selYear.innerHTML = "";
    years.forEach(y => {
        const opt = new Option(y + 543, y);
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (y === currentYear || (years.length > 0 && y === years[0])) {
            opt.selected = true;
        }
        selYear.add(opt);
    });

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (1-31)
    selDay.innerHTML = "";
    for (let d = 1; d <= 31; d++) {
        // Option(text, value, defaultSelected, selected)
        selDay.add(new Option(d, d, true, true));
    }

    // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Filter ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateDashFilters();
}

function updateDashFilters() {
    const type = document.getElementById('viewType').value;
    const selSub = document.getElementById('selSub');
    const lblSub = document.getElementById('lblSub');
    const dayBox = document.getElementById('dayBox');

    if (!selSub) return;

    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
    selSub.innerHTML = "";

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (type === 'daily' || type === 'monthly') {
        if (lblSub) lblSub.innerText = "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
        
        // ‡πÉ‡∏ä‡πâ MONTHS_TH (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß)
        if (typeof MONTHS_TH !== 'undefined') {
            MONTHS_TH.forEach((m, i) => {
                // Option(‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ä‡∏ß‡πå, ‡∏Ñ‡πà‡∏≤ value, defaultSelected, selected)
                const opt = new Option(m, i + 1, true, true); 
                selSub.add(opt);
            });
        }
        
        if (dayBox) dayBox.style.display = (type === 'daily') ? 'block' : 'none';

    } else if (type === 'quarterly') {
        if (lblSub) lblSub.innerText = "‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™";
        [1, 2, 3, 4].forEach(q => {
            const opt = new Option(`‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ ${q}`, q, true, true);
            selSub.add(opt);
        });
        if (dayBox) dayBox.style.display = 'none';
    }

    // 3. ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ Select2 ‡∏´‡∏£‡∏∑‡∏≠ Bootstrap Multiselect ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á Refresh ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    if (typeof $ !== 'undefined' && $(selSub).data('select2')) {
        $(selSub).trigger('change');
    }

    // 4. ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Dashboard ‡πÉ‡∏´‡∏°‡πà
    // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô HTML ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    setTimeout(() => {
        processDashboard();
    }, 50);
}
function processDashboard() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á Element ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    const viewTypeEl = document.getElementById('viewType');
    const selYearEl = document.getElementById('selYear');
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ currentUser ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error
    if (!viewTypeEl || !selYearEl || typeof currentUser === 'undefined' || !currentUser) return;

    const type = viewTypeEl.value;
    const selectedYear = parseInt(selYearEl.value);
    const year = selectedYear > 2500 ? selectedYear - 543 : selectedYear; 
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠)
    const selectedMonths = Array.from(document.getElementById('selSub')?.selectedOptions || []).map(o => parseInt(o.value));
    const selectedDays = Array.from(document.getElementById('selDay')?.selectedOptions || []).map(o => parseInt(o.value));

    // üö© ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
    if (selectedMonths.length === 0 || (type === 'daily' && selectedDays.length === 0)) {
        if (typeof clearDashboardUI === 'function') clearDashboardUI();
        return;
    }

    const todayStr = new Date().toLocaleDateString('en-CA');
    let todayStats = { cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0, total: 0, target: 0 };
    let groups = {};

    const generateKey = (dateObj) => {
        const rowYear = dateObj.getFullYear();
        const m = dateObj.getMonth() + 1;
        const d = dateObj.getDate();
        if (type === 'daily') return `${rowYear}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        if (type === 'monthly') return `${rowYear}-${String(m).padStart(2, '0')}`;
        return `Q${Math.ceil(m / 3)}`;
    };

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Target (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ö‡∏ß‡∏Å‡∏™‡∏∞‡∏™‡∏°) ---
if (typeof allPlans !== 'undefined' && allPlans) {
    allPlans.forEach(p => {
        if (!p[0] || !p[1]) return;
        const dt = new Date(p[0]);
        
        if (isNaN(dt.getTime()) || p[1].toString().trim().toLowerCase() !== currentUser.trim().toLowerCase()) return;
        if (dt.getFullYear() !== year) return;

        const m = dt.getMonth() + 1;
        if (!selectedMonths.includes(m)) return;
        if (type === 'daily' && !selectedDays.includes(dt.getDate())) return;
        
        const key = generateKey(dt);
        if (!groups[key]) {
            groups[key] = { total: 0, target: 0, cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0, caseIds: new Set() };
        }

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å = ‡πÄ‡∏õ‡πá‡∏ô += ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏° Target ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô Key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™)
        const val = Number(p[3] || 0);
        groups[key].target += val;

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Today)
        if (dt.toLocaleDateString('en-CA') === todayStr) {
            todayStats.target = val; 
        }
    });
}

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Actual ---
    const combinedData = [
        ...(typeof allArchive !== 'undefined' ? allArchive : []), 
        ...(typeof allData !== 'undefined' ? allData : [])
    ];

    combinedData.forEach((d, idx) => {
        if (!d[0] || !d[1] || d[0] === "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà") return;
        const dt = new Date(d[0]);
        if (isNaN(dt.getTime()) || d[1].toString().trim().toLowerCase() !== currentUser.trim().toLowerCase()) return;
        if (dt.getFullYear() !== year) return;

        const m = dt.getMonth() + 1;
        if (!selectedMonths.includes(m)) return;
        if (type === 'daily' && !selectedDays.includes(dt.getDate())) return;

        const key = generateKey(dt);
        if (!groups[key]) {
            groups[key] = { total: 0, target: 0, cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0, caseIds: new Set() };
        }

        const isSummary = d.length > 5 && !isNaN(d[3]) && d[3] !== ""; 
        if (isSummary) {
            groups[key].total += Number(d[3] || 0);
            groups[key].cp    += Number(d[4] || 0);
            groups[key].call  += Number(d[5] || 0);
        } else {
            const caseId = d[3] ? d[3].toString().trim() : `idx-${idx}`;
            if (!groups[key].caseIds.has(caseId)) {
                groups[key].caseIds.add(caseId);
                groups[key].total++; 
                const cat = d[2] ? d[2].toString().trim() : "";
                if (cat === "CP No.") groups[key].cp++;
                else if (cat === "Call IN") groups[key].call++;
                else if (cat === "IR") groups[key].ir++;
                else if (cat === "SR") groups[key].sr++;
                else if (cat === "Drop Call") groups[key].drop++;
                else if (cat === "Campaign") groups[key].camp++;
            }
        }

        if (dt.toLocaleDateString('en-CA') === todayStr) {
            if (!todayStats._uSet) todayStats._uSet = new Set();
            const cId = d[3] ? d[3].toString().trim() : `t-idx-${idx}`;
            if (!todayStats._uSet.has(cId)) {
                todayStats._uSet.add(cId);
                todayStats.total++;
            }
        }
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°) ---
    requestAnimationFrame(() => {
        try {
            if (typeof updateTodayUI === 'function') updateTodayUI(todayStats);
            
            const validKeys = Object.keys(groups);
            if (validKeys.length > 0) {
                if (typeof renderChart === 'function') renderChart(groups);
                if (typeof renderDashTable === 'function') renderDashTable(groups); 
            } else {
                if (typeof clearDashboardUI === 'function') clearDashboardUI();
            }

            const actualCountEl = document.getElementById('actualCount');
            if (actualCountEl) actualCountEl.innerText = todayStats.total;
        } catch (e) { console.warn("UI Update Error:", e); }
    });
}function clearDashboardUI() {
    const tbody = document.getElementById('dashTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    if (typeof renderChart === 'function') renderChart({}); 
}
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞ Progress Bar ‡πÑ‡∏•‡πà‡∏™‡∏µ
function updateTodayUI(s) {
    if (!s) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏°‡∏≤

    const badgeMap = { "badge-CP": s.cp, "badge-Call": s.call, "badge-IR": s.ir, "badge-SR": s.sr, "badge-Drop": s.drop, "badge-Camp": s.camp };
    for (let id in badgeMap) {
        if (document.getElementById(id)) document.getElementById(id).innerText = badgeMap[id] || 0;
    }

    if (document.getElementById('displayTarget')) document.getElementById('displayTarget').innerText = s.target;
    if (document.getElementById('displayActual')) document.getElementById('displayActual').innerText = s.total;

    const balanceEl = document.getElementById('displayBalance');
    if (balanceEl) {
        const balance = s.total - s.target;
        balanceEl.innerText = balance;
        balanceEl.style.color = balance < 0 ? "#dc3545" : (balance > 0 ? "#28a745" : "#ff9800");
    }

     // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Progress Bar (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏ó‡∏∏‡∏Å 5%)
    const percent = s.target > 0 ? Math.round((s.total / s.target) * 100) : 0;
    const bar = document.getElementById('goalProgress');
    
    if (bar) {
        bar.style.width = Math.min(100, percent) + '%';
        bar.innerText = percent + '%';
        
        // ‡∏•‡πâ‡∏≤‡∏á Class ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
        bar.className = "progress-bar-fill"; 
        bar.style.backgroundImage = "none"; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏™‡∏µ Gradient ‡πÄ‡∏î‡∏¥‡∏°

        // --- ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏•‡πà‡∏™‡∏µ‡πÅ‡∏ö‡∏ö Interval ‡∏•‡∏∞ 5% ---
        let bgColor = "";
        let textColor = "white";

        if (percent <= 5)       bgColor = "#8B0000"; // 0-5%: ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏°‡∏≤‡∏Å (Dark Red)
        else if (percent <= 10) bgColor = "#A52A2A"; // 6-10%: ‡πÅ‡∏î‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
        else if (percent <= 15) bgColor = "#B22222"; // 11-15%: ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏•‡∏¥‡∏á
        else if (percent <= 20) bgColor = "#DC3545"; // 16-20%: ‡πÅ‡∏î‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        else if (percent <= 25) bgColor = "#E35D6A"; // 21-25%: ‡πÅ‡∏î‡∏á‡∏ä‡∏°‡∏û‡∏π
        else if (percent <= 30) bgColor = "#EA868F"; // 26-30%: ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô
        else if (percent <= 35) bgColor = "#F1AFB5"; // 31-35%: ‡πÅ‡∏î‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•
        else if (percent <= 40) bgColor = "#FD7E14"; // 36-40%: ‡∏™‡πâ‡∏°
        else if (percent <= 45) bgColor = "#FF8C00"; // 41-45%: ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
        else if (percent <= 50) bgColor = "#FFD700"; // 46-50%: ‡∏ó‡∏≠‡∏á
        else if (percent <= 60) bgColor = "#CC9A06"; // 51-60%: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°
        else if (percent <= 80) bgColor = "#F1C40F"; // 61-80%: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á
        else if (percent < 100) bgColor = "#A9DFBF"; // 81-99%: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå
        else {
            bgColor = "#28A745"; // 100% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        }

        // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
        if (percent > 45 && percent < 100) textColor = "black";

        // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á‡∏ö‡∏ô Element
        bar.style.backgroundColor = bgColor;
        bar.style.color = textColor;
    }
}

function renderDashTable(groups) {
    const keys = Object.keys(groups).sort().reverse();
    const tbody = document.getElementById('dashTableBody');
    const tableHeader = document.querySelector('#tab-dash thead');
    
    if (!tbody || !tableHeader) return;

    tableHeader.innerHTML = `
        <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th style="color: #ff9800;">CP</th>
            <th>Call</th>
            <th>IR</th>
            <th>SR</th>
            <th>Drop</th>
            <th>Camp</th>
            <th class="table-primary">Actual</th>
            <th>Target</th>
            <th>%</th>
        </tr>
    `;

    if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
    }

    tbody.innerHTML = keys.map(k => {
        const g = groups[k];
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Target ---
        const targetValue = Number(g.target || 0);
        const actualValue = Number(g.total || 0);
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Target ‡πÉ‡∏´‡πâ pct ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô N/A ‡∏´‡∏£‡∏∑‡∏≠ 0%
        const pct = targetValue > 0 ? Math.round((actualValue / targetValue) * 100) : 0;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Target ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (Muted)
        let customColor = '#6c757d'; 
        
        if (targetValue > 0) {
            customColor = '#28A745'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            if (pct <= 5)       customColor = '#8B0000';
            else if (pct <= 10) customColor = '#A52A2A'; 
            else if (pct <= 15) customColor = '#B22222';
            else if (pct <= 20) customColor = '#DC3545';
            else if (pct <= 25) customColor = '#E35D6A';
            else if (pct <= 30) customColor = '#EA868F';
            else if (pct <= 40) customColor = '#FD7E14';
            else if (pct <= 60) customColor = '#CC9A06';
            else if (pct <= 80) customColor = '#F1C40F';
            else if (pct < 100) customColor = '#A9DFBF';
        }

        return `
            <tr>
                <td class="fw-bold small">${k}</td>
                <td>${g.cp || 0}</td>
                <td>${g.call || 0}</td>
                <td>${g.ir || 0}</td>
                <td>${g.sr || 0}</td>
                <td>${g.drop || 0}</td>
                <td>${g.camp || 0}</td>
                <td class="table-primary fw-bold" style="background-color: #e3f2fd !important;">${actualValue}</td>
                <td class="${targetValue === 0 ? 'text-danger' : ''}">${targetValue || '-'}</td>
                <td class="fw-bold" style="color: ${customColor} !important;">
                    ${targetValue > 0 ? pct + '%' : '<span class="text-muted" style="font-size: 0.8em;">No Target</span>'}
                </td>
            </tr>
        `;
    }).join('');
}

// --- 7. UI HELPERS ---
function showTab(t) {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-completely'));
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const targetTab = document.getElementById('tab-' + t);
    if (targetTab) targetTab.classList.remove('hidden-completely');
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
    const targetBtn = document.getElementById('nav-' + t);
    if (targetBtn) targetBtn.classList.add('active-btn');
    
    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
    if (t === 'dash') {
        processDashboard();
    }
}

    function toggleHistoryVisibility() {
        document.getElementById('historyContent').classList.toggle('hidden-completely');
    }

 function updateHistory() {
    const historyBody = document.getElementById('historyBody');
    if (!historyBody || typeof allData === 'undefined') return;

    // 1. ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    const now = new Date();
    const todayStr = now.toLocaleDateString('en-CA'); 

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    const history = allData.filter(d => {
        if (!d[0]) return false;
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà YYYY-MM-DD ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å
        const rowDateStr = new Date(d[0]).toLocaleDateString('en-CA');
        return rowDateStr === todayStr && d[1] === currentUser;
    }).reverse(); 

    if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    historyBody.innerHTML = history.map(d => {
        const dateObj = new Date(d[0]);
        const time = isNaN(dateObj) ? "--:--" : dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return `
            <tr>
                <td class="text-secondary small">${time} ‡∏ô.</td>
                <td class="fw-bold">${d[3] || '-'}</td>
                <td><span class="badge bg-light text-dark border">${d[2]}</span></td>
            </tr>
        `;
    }).join('');
}
processDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞ Dashboard
updateHistory();    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°

    setInterval(() => {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH', { hour12: false });
    const dateStr = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long' });

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ (‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HTML ‡∏Ñ‡∏∑‡∏≠ displayTime)
    const clockEl = document.getElementById('displayTime');
    if (clockEl) clockEl.innerText = timeStr;

    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HTML ‡∏Ñ‡∏∑‡∏≠ displayDate)
    const dateEl = document.getElementById('displayDate');
    if (dateEl) dateEl.innerText = dateStr;

    // 3. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏´‡∏≤‡∏Å‡∏´‡∏≤ ID 'bigClock' ‡∏´‡∏£‡∏∑‡∏≠ 'todayDateLabel' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    const bigClock = document.getElementById('bigClock');
    if (bigClock) bigClock.innerText = timeStr;
    
    const dateLabel = document.getElementById('todayDateLabel');
    if (dateLabel) dateLabel.innerText = dateStr;

}, 1000);

    function changeChartType(t) {
        currentChartType = t;
        document.getElementById('btn-bar').classList.toggle('active', t==='bar');
        document.getElementById('btn-line').classList.toggle('active', t==='line');
        processDashboard();
    }
 function parseCPData() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á
    const val4G = document.getElementById('cpInput4G').value.trim();
    const val5G = document.getElementById('cpInput5G').value.trim();
    const valAddr = document.getElementById('cpInputAddr').value.trim();

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4G/5G)
    const cleanLines = (text) => text.split('\n').map(l => l.trim()).filter(line => line.length > 0);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G ---
    if (val4G) {
        const lines4G = cleanLines(val4G);
        if (lines4G.length >= 2) document.getElementById('td-imsi').innerText = lines4G[1];
        if (lines4G.length >= 5) {
            document.getElementById('td-4gcell').innerText = `${lines4G[0]} ${lines4G[4]} ${lines4G[2]}`;
        }
        if (lines4G.length >= 7) document.getElementById('td-4grsrp').innerText = lines4G[6];
        if (lines4G.length >= 8) document.getElementById('td-4grsrq').innerText = lines4G[7];
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G ---
    if (val5G) {
        const lines5G = cleanLines(val5G);
        // IMSI: ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á 4G ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á 5G ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2
        const currentIMSI = document.getElementById('td-imsi').innerText;
        if (lines5G.length >= 2 && (currentIMSI === "-" || currentIMSI === "")) {
            document.getElementById('td-imsi').innerText = lines5G[1];
        }
        if (lines5G.length >= 5) {
            document.getElementById('td-5gcell').innerText = `${lines5G[0]} ${lines5G[4]} ${lines5G[2]}`;
        }
        if (lines5G.length >= 9) document.getElementById('td-5grsrp').innerText = lines5G[8];
        if (lines5G.length >= 10) document.getElementById('td-5gsinr').innerText = lines5G[9];
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Address ---
    if (valAddr) {
        // ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Index ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á)
        const lines = valAddr.split('\n').map(l => l.trim());
        let addr = { no: "-", bld: "-", soi: "-", rd: "-", tmb: "-", amp: "-", prv: "-", ldm: "-" };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        const findValue = (startIndex) => {
            for (let i = 1; i <= 3; i++) {
                let nextLine = lines[startIndex + i] ? lines[startIndex + i].trim() : "";
                if (nextLine !== "" && !nextLine.includes(":") && !nextLine.includes("‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")) {
                    return nextLine;
                } else if (nextLine.includes(":") || nextLine.includes("‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")) {
                    break;
                }
            }
            return "-";
        };

        lines.forEach((line, index) => {
            if (line.includes(":")) {
                const parts = line.split(":");
                const label = parts[0].trim().toLowerCase();
                let val = parts[1] ? parts[1].trim() : "";

                // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á : ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á/0/- ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                if (val === "" || val === "-" || val === "0" || val === "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
                    val = findValue(index);
                }

                if (label.includes("address no")) addr.no = val;
                if (label.includes("location/building")) addr.bld = val;
                if (label.includes("soi")) addr.soi = val;
                if (label.includes("road")) addr.rd = val;
                if (label.includes("tumbol")) addr.tmb = val;
                if (label.includes("amphur")) addr.amp = val;
                if (label.includes("province")) addr.prv = val;
                if (label.includes("‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï")) addr.ldm = val;
            }
        });

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Formatted Address
        const formatted = [
            (addr.no !== "-" ? addr.no : "-"),
            (addr.bld !== "-" && addr.bld !== "" && addr.bld !== "0" ? "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ " + addr.bld : ""),
            "‡∏ã." + (addr.soi !== "-" ? addr.soi : "-"),
            "‡∏ñ." + (addr.rd !== "-" ? addr.rd : "-"),
            "‡∏ï." + (addr.tmb !== "-" ? addr.tmb : "-"),
            "‡∏≠." + (addr.amp !== "-" ? addr.amp : "-"),
            "‡∏à." + (addr.prv !== "-" ? addr.prv : "-"),
            (addr.ldm !== "-" ? "(‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: " + addr.ldm + ")" : "(‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: -)")
        ].filter(x => x !== "").join(" ");

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        const targetCell = document.getElementById('td-address');
        if (targetCell) {
            targetCell.innerText = formatted;
        }
    }

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏î Sync/Login ---
    const now = new Date();
    const timeString = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH', { hour12: false }) + ' ‡∏ô.';
    
    const syncTimeSpan = document.getElementById('lastSyncTime');
    const syncTimeDiv = document.getElementById('syncTimeSection');
    
    if (syncTimeSpan) {
        syncTimeSpan.innerText = timeString;
    }
    if (syncTimeDiv) {
        syncTimeDiv.classList.remove('d-none'); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î Sync
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    const summary = document.getElementById('cpSummarySection');
    if (summary) summary.classList.remove('d-none');

} // ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parseCPData ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

// 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
let autoSyncInterval = null;

/**
 * üîÑ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sync ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á (Single Source of Truth)
 */
function runSyncProcess() {
    const now = new Date();
    const shortTime = now.toLocaleTimeString('th-TH', { hour12: false });
    const fullDate = now.toLocaleDateString('th-TH');

    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
    const elAuto = document.getElementById('autoSyncTime');
    if (elAuto) elAuto.innerText = `${fullDate} ${shortTime}`;

    const elMain = document.getElementById('displayTime');
    if (elMain) elMain.innerText = shortTime;

    // --- ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡πÅ‡∏•‡πâ‡∏ß) ---
    try {
        if (typeof currentUser !== 'undefined' && currentUser) {
            if (typeof parseCPData === 'function') parseCPData();

            // ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Set ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Dashboard/‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                if (typeof processDashboard === 'function') {
                    processDashboard(); 
                }
            }, 300);
        }
    } catch (err) {
        console.warn("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...");
    }
}

/**
 * ‚öôÔ∏è 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤)
 */
function startManagementSystem() {
    runSyncProcess(); // ‡∏£‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Timer ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô
    if (window.mainSyncTimer) clearInterval(window.mainSyncTimer);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
    window.mainSyncTimer = setInterval(runSyncProcess, 60000);
}

/**
 * üöÄ 3. ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Single Entry Point)
 */
window.addEventListener('load', () => {
    // ‡∏Å. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πá‡∏°‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    setInterval(() => {
        const timeEl = document.getElementById('displayTime');
        if (timeEl) timeEl.innerText = new Date().toLocaleTimeString('th-TH', { hour12: false });
    }, 1000);

    // ‡∏Ç. ‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ Sync ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    runSyncProcess();

    // ‡∏Ñ. ‡∏´‡∏≤‡∏Å‡∏°‡∏µ User ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Sync ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (typeof currentUser !== 'undefined' && currentUser) {
        startManagementSystem();
    }
    
    console.log("üöÄ System Services Started.");
});

function clearCP() {
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Textarea ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const inputs = ['cpInput4G', 'cpInput5G', 'cpInputAddr'];
    inputs.forEach(id => {
        const inputEl = document.getElementById(id);
        if (inputEl) inputEl.value = "";
    });

    // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (class .cp-value-custom)
    document.querySelectorAll('.cp-value-custom').forEach(td => {
        td.innerText = "-";
    });

    // 3. ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
    const summarySection = document.getElementById('cpSummarySection');
    if (summarySection) summarySection.classList.add('d-none');
    
    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    Swal.fire({
        title: '‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        icon: 'success',
        timer: 1500, // ‡πÅ‡∏™‡∏î‡∏á 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
        showConfirmButton: false, // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏Å‡∏•‡∏á
        position: 'center' // ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    });

    console.log("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Auto Sync ‡πÉ‡∏ô Navbar ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)");
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Copy Table ---
function copyCPTable() {
    const table = document.getElementById('cpTable');
    if (!table) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        return;
    }

    try {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Range ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const range = document.createRange();
        range.selectNode(table);
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
        const successful = document.execCommand('copy');
        
        // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏´‡∏•‡∏±‡∏á‡∏Å‡πä‡∏≠‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à
        selection.removeAllRanges();

        if (successful) {
            Swal.fire({
                icon: 'success',
                title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                text: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Line ‡∏´‡∏£‡∏∑‡∏≠ Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                timer: 1500,
                showConfirmButton: false
            });
        }
    } catch (err) {
        console.error('Copy failed', err);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
    }
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Actual / Target / Badges) ---
function updateHomeStats() {
    // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const myTodayData = allData.filter(d => {
        const rowDate = new Date(d[0]).toISOString().split('T')[0];
        return rowDate === todayStr && d[1] === currentUser;
    });

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Target): ‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const myPlan = allPlans.find(p => {
        const planDate = new Date(p[0]).toISOString().split('T')[0];
        return planDate === todayStr && p[1] === currentUser;
    });

    const target = myPlan ? parseInt(myPlan[3]) : 0;
    const actual = myTodayData.length;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Actual / Target ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    document.getElementById('displayTarget').innerText = target;
    document.getElementById('displayActual').innerText = actual;
    document.getElementById('displayBalance').innerText = actual - target;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Badges)
    const badgeMap = { 
        "CP No.": "badge-CP", 
        "Call IN": "badge-Call", 
        "IR": "badge-IR", 
        "SR": "badge-SR", 
        "Drop Call": "badge-Drop", 
        "Campaign": "badge-Camp" 
    };

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Badge ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πà‡∏≠‡∏ô
    Object.values(badgeMap).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = "0";
    });

    // ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Badge
    myTodayData.forEach(d => {
        const category = d[2];
        const elementId = badgeMap[category];
        if (elementId) {
            const el = document.getElementById(elementId);
            el.innerText = parseInt(el.innerText) + 1;
        }
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ---
function updateHistory() {
    // 1. ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏°‡∏∑‡∏î)
    const todayStr = new Date().toLocaleDateString('en-CA');
    const historyBody = document.getElementById('historyBody');
    
    if (!historyBody) return;

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const history = allData.filter(d => {
        const rowDate = new Date(d[0]).toLocaleDateString('en-CA');
        return rowDate === todayStr && d[1] === currentUser;
    }).reverse();

    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }

    // 4. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    historyBody.innerHTML = history.map(d => {
        const time = new Date(d[0]).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return `
            <tr>
                <td class="text-secondary">${time} ‡∏ô.</td>
                <td class="fw-bold">${d[3]}</td> <td><span class="badge bg-light text-dark border">${d[2]}</span></td> </tr>
        `;
    }).join('');
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderPlanTable() {
    const tbody = document.getElementById('planTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á currentUser
    const myPlans = allPlans.filter(p => p[1] === currentUser)
                            .sort((a, b) => new Date(b[0]) - new Date(a[0])); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

    myPlans.forEach((p, index) => {
        const dateStr = new Date(p[0]).toLocaleDateString('th-TH', { 
            year: 'numeric', month: 'short', day: 'numeric' 
        });
        
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td class="fw-bold text-primary">${p[3]}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deletePlan('${p[0]}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
async function saveNewPlan() {
    const date = document.getElementById('planDate').value;
    const target = document.getElementById('planTarget').value;

    if (!date || !target) {
        Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' });
        return;
    }

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô...', didOpen: () => { Swal.showLoading(); } });

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'savePlan', // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô GS ‡∏°‡∏µ action ‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
                user: currentUser,
                date: date,
                target: target
            })
        });

        const result = await response.json();
        if (result.status === "success") {
            Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false });
            document.getElementById('planTarget').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
            await initData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            renderPlanTable(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            processDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ
        }
    } catch (e) {
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }
}
function startArchiveProcess() {
    const statusDiv = document.getElementById('archiveStatus');
    statusDiv.style.display = 'block'; 
    statusDiv.innerHTML = '‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
    statusDiv.className = "alert alert-info border-0 shadow-sm";

    google.script.run
      .withSuccessHandler(function(msg) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server
        if (msg === "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") {
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            statusDiv.className = "alert alert-success border-0 shadow-sm text-success";
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Dashboard
            if (typeof processDashboard === "function") processDashboard(); 
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + msg;
            statusDiv.className = "alert alert-warning border-0 shadow-sm";
        }
      })
      .withFailureHandler(function(err) {
        statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        statusDiv.className = "alert alert-danger border-0 shadow-sm";
      })
      .archiveAndCleanupDaily();
}
async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            inputs.forEach(i => i.value = ""); 
            
            Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', html: result.message, timer: 1000, showConfirmButton: false });

            // --- üöÄ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ Auto Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ---
            const syncTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const syncElement = document.querySelector('.text-end small'); 
            if (syncElement) {
                syncElement.innerHTML = `<i class="bi bi-arrow-repeat"></i> Auto Sync ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${syncTime}`;
            }

            await initData(); 
            
            if (typeof processDashboard === 'function') {
                processDashboard(); 
            }
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}
</script>
<script>
    (function() {
        function updateAll() {
            const now = new Date();
            const dateEl = document.getElementById('displayDate');
            const timeEl = document.getElementById('displayTime');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
            if (dateEl) {
                dateEl.innerText = now.toLocaleDateString('th-TH', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            if (timeEl) {
                timeEl.innerText = now.toLocaleTimeString('th-TH', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                });
            }
        }
        
        // ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        updateAll();
        setInterval(updateAll, 1000);
    })();
</script>
</body>
</html>