<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V.92 - Hybrid Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --deep-orange: #e65100;
            --bright-orange: #ff8c00;
            --bg-liquid: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);
        }

        /* Base UI */
        body { font-family: 'Prompt', sans-serif; background: var(--bg-liquid); min-height: 100vh; color: #2d3436; margin: 0; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 15px; }
        .hidden-completely { display: none !important; }

        /* Navigation */
        .nav-btn { border: none; background: none; color: #636e72; font-weight: 600; padding: 10px; transition: 0.3s; flex: 1; font-size: 0.85rem; border-radius: 12px; }
        .nav-btn.active-btn { background: var(--bright-orange); color: white; box-shadow: 0 4px 10px rgba(255,140,0,0.3); }

        /* Dashboard Filter Grid */
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; align-items: stretch; width: 100%; }
        .filter-box { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; display: flex; flex-direction: column; }
        .filter-box select { width: 100%; border: 1px solid #ccc; border-radius: 5px; padding: 4px; margin-top: 5px; flex-grow: 1; font-size: 0.8rem; }
        .filter-label { font-weight: bold; font-size: 0.8rem; color: #555; }

        /* Progress & Badges */
        .progress-wrapper { background: rgba(0,0,0,0.05); height: 26px; border-radius: 13px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8c00, #ffb347, #ff8c00); transition: width 1s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
        .count-circle { background: linear-gradient(135deg, #ff9100, #ffea00); color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; margin-right: 4px; }

        /* CP Detail Table */
        .cp-table-render { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; background: white; border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .cp-table-render td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .cp-label-custom { background-color: #fff8e1; font-weight: 600; color: var(--deep-orange); width: 40%; border-right: 1px solid #f0f0f0; }
        .cp-value-custom { background-color: #ffffff; color: #333; }
        .cp-section-title { background: linear-gradient(90deg, var(--bright-orange), var(--deep-orange)); color: white; font-weight: bold; padding: 8px 15px; font-size: 0.9rem; }

        /* Loader */
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--bright-orange); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<section id="loginSection" style="position:fixed; inset:0; z-index:9999; background:var(--bg-liquid); display:flex; align-items:center; justify-content:center;">
    <div class="glass-card text-center shadow-lg" style="width:90%; max-width:350px;">
        <h3 class="fw-bold mb-4" style="color:var(--deep-orange)">üçä Performance</h3>
        <div id="loginInputs">
            <input type="text" id="user" class="form-control rounded-pill mb-3" placeholder="Username">
            <input type="password" id="pass" class="form-control rounded-pill mb-4" placeholder="Password">
            <button onclick="login()" class="btn btn-warning w-100 fw-bold text-white rounded-pill py-2 shadow-sm">LOGIN</button>
        </div>
        <div id="loginStatus" class="hidden-completely">
            <div class="loader-spinner"></div>
            <p class="mb-1 fw-bold text-secondary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</p>
            <p id="targetUserDisplay" class="text-warning small"></p>
        </div>
    </div>
</section>

<main id="mainSection" class="hidden-completely">
    <nav class="navbar glass-card m-2 p-2">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="fw-bold" style="color:var(--bright-orange)">üçä PERFORMANCE V.92</span>
            <div class="text-end small">
                <b id="empName"></b> | <a href="#" onclick="location.reload()" class="text-danger text-decoration-none">‡∏≠‡∏≠‡∏Å</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="glass-card d-flex gap-1 p-1 mb-3" style="border-radius: 15px; overflow-x: auto;">
            <button id="nav-record" class="btn nav-btn active-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="nav-cp" class="btn nav-btn" onclick="showTab('cp')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î CP</button>
            <button id="nav-dash" class="btn nav-btn" onclick="showTab('dash')">‡∏™‡∏£‡∏∏‡∏õ</button>
            <button id="nav-assign" class="btn nav-btn" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center">
                <div class="d-flex justify-content-between mb-3">
                    <div class="text-start">
                        <div class="small fw-bold text-secondary" id="todayDateLabel"></div>
                        <div id="bigClock" style="font-size: 1.8rem; font-weight:700; color:var(--deep-orange)">00:00:00</div>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="initData()"><i class="fa-solid fa-sync"></i> Sync</button>
                        <div class="small text-muted mt-1" id="lastSyncTime" style="font-size: 0.65rem;"></div>
                    </div>
                </div>

                <div class="progress-wrapper mb-3"><div id="goalProgress" class="progress-bar-fill">0%</div></div>
                
                <div class="row g-2 mb-4 border-bottom pb-3">
                    <div class="col-4">Target<br><b id="displayTarget">0</b></div>
                    <div class="col-4 text-primary">Actual<br><b id="displayActual">0</b></div>
                    <div class="col-4">Balance<br><b id="displayBalance">0</b></div>
                </div>

                <div class="row g-3">
                    <div class="col-4 small"><span class="count-circle" id="badge-CP">0</span> CP<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="CP No." placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Call">0</span> Call<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Call IN" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-IR">0</span> IR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="IR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-SR">0</span> SR<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="SR" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Drop">0</span> Drop<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Drop Call" placeholder="ID"></div>
                    <div class="col-4 small"><span class="count-circle" id="badge-Camp">0</span> Camp<input type="text" class="form-control form-control-sm cat-input mt-1" data-cat="Campaign" placeholder="ID"></div>
                </div>
                
                <button onclick="saveWork()" class="btn btn-warning w-100 text-white fw-bold py-3 mt-4 rounded-pill shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold m-0 small"><i class="fa-solid fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistoryVisibility()">
                        <i class="fa-solid fa-eye"></i> ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
                    </button>
                </div>
                <div id="historyContent" class="hidden-completely">
                    <div class="table-responsive">
                        <table class="table table-sm" style="font-size: 0.75rem;">
                            <tbody id="historyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cp" class="tab-content">
    <div class="glass-card">
        <h6 class="fw-bold mb-3" style="color:var(--deep-orange)">
            <i class="fa-solid fa-bolt me-2"></i>Smart CP Splitter
        </h6>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="small fw-bold text-primary">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G (IMSI ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2 / Signal 7,8):</label>
                <textarea id="cpInput4G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-danger">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G (Signal ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 9,10):</label>
                <textarea id="cpInput5G" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G..." oninput="parseCPData()"></textarea>
            </div>

            <div class="col-md-4">
                <label class="small fw-bold text-success">3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address):</label>
                <textarea id="cpInputAddr" class="form-control form-control-sm" rows="5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà..." oninput="parseCPData()"></textarea>
            </div>
        </div>
        
        <div class="table-responsive">
    <table class="cp-table-render" id="cpTable">
        <thead>
            <tr><th colspan="2" class="cp-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)</th></tr>
        </thead>
        <tbody>
            <tr><td class="cp-label-custom">IMSI :</td><td id="td-imsi" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GCell Name:</td><td id="td-4gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4G Signal Strength :</td><td id="td-4grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">4GSignal Quality :</td><td id="td-4grsrq" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GCell Name:</td><td id="td-5gcell" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5G Signal Strength :</td><td id="td-5grsrp" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">5GSignal Quality :</td><td id="td-5gsinr" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (Address) :</td><td id="td-address" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Remark :</td><td id="td-remark" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Arpu :</td><td id="td-arpu" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Service Year :</td><td id="td-service-year" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package :</td><td id="td-package" class="cp-value-custom" contenteditable="true">-</td></tr>
            <tr><td class="cp-label-custom">Package Remaining :</td><td id="td-package-remaining" class="cp-value-custom" contenteditable="true">-</td></tr>
        </tbody>
    </table>
</div>

        <div class="row g-2 mt-3">
            <div class="col-4">
                <button class="btn btn-light w-100 rounded-pill border fw-bold" onclick="clearCP()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div class="col-8">
                <button class="btn btn-warning w-100 rounded-pill text-white fw-bold shadow" onclick="copyCPTable()">
                    <i class="fa-regular fa-copy me-2"></i>Copy Table
                </button>
            </div>
        </div>
    </div>
</div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-chart-line me-2"></i>Performance Summary</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning active" id="btn-bar" onclick="changeChartType('bar')">Bar</button>
                        <button class="btn btn-outline-warning" id="btn-line" onclick="changeChartType('line')">Line</button>
                    </div>
                </div>

                <div class="filter-row mb-3">
                    <div class="filter-box"><label class="filter-label">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="viewType" onchange="updateDashFilters()"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option></select></div>
                    <div class="filter-box"><label class="filter-label">‡∏õ‡∏µ</label><select id="selYear" onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="monthBox"><label class="filter-label" id="lblSub">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select id="selSub" multiple onchange="processDashboard()"></select></div>
                    <div class="filter-box" id="dayBox"><label class="filter-label">‡∏ß‡∏±‡∏ô</label><select id="selDay" multiple onchange="processDashboard()"></select></div>
                </div>

                <div style="height: 250px;"><canvas id="perfChart"></canvas></div>
                
                <div class="table-responsive mt-3" style="max-height: 300px;">
                    <table class="table table-sm text-center small">
                        <thead class="table-light sticky-top">
                            <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>Actual</th><th>Target</th><th>%</th></tr>
                        </thead>
                        <tbody id="dashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
            <div class="glass-card">
                <h6 class="fw-bold mb-3">üìÖ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h6>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="date" id="planDate" class="form-control form-control-sm"></div>
                    <div class="col-3"><select id="planVal" class="form-select form-select-sm"><option value="72">72</option><option value="36">36</option></select></div>
                    <div class="col-3"><button onclick="savePlan()" class="btn btn-warning btn-sm w-100 text-white shadow-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm text-center small">
                        <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="planTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- 1. CONFIG & GLOBALS ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    const MONTHS_TH = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    let currentUser = "", allData = [], allPlans = [], chartInstance = null, currentChartType = 'bar';

    // --- 2. AUTH ---
    async function login() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return;
        document.getElementById('loginInputs').classList.add('hidden-completely');
        document.getElementById('loginStatus').classList.remove('hidden-completely');
        document.getElementById('targetUserDisplay').innerText = `User: ${u}`;
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.status === "success") {
                currentUser = data.name;
                document.getElementById('empName').innerText = currentUser;
                document.getElementById('loginSection').classList.add('hidden-completely');
                document.getElementById('mainSection').classList.remove('hidden-completely');
                initData();
                setInterval(initData, 60000);
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                document.getElementById('loginInputs').classList.remove('hidden-completely');
                document.getElementById('loginStatus').classList.add('hidden-completely');
            }
        } catch(e) { location.reload(); }
    }

    // --- 3. DATA ENGINE ---
    async function initData() {
    try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();
        allData = json.data.slice(1);
        allPlans = json.plans.slice(1);
        
        setupFilters(); // <--- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô
        updateHomeStats();
        updateHistory();
        renderPlanTable();
        
        if (chartInstance) processDashboard();
    } catch(e) { console.error("Sync Error:", e); }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ)
function setupFilters() {
    const selYear = document.getElementById('selYear');
    if (selYear.options.length > 0) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥
    
    const curY = new Date().getFullYear();
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    [curY, curY - 1].forEach(y => selYear.add(new Option(y + 543, y)));
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô 1-31
    const selDay = document.getElementById('selDay');
    selDay.innerHTML = "";
    for (let d = 1; d <= 31; d++) {
        const opt = new Option(d, d, false, true); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô default
        selDay.add(opt);
    }
    
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateDashFilters();
}

function updateDashFilters() {
    const type = document.getElementById('viewType').value;
    const selSub = document.getElementById('selSub');
    const monthBox = document.getElementById('monthBox');
    const dayBox = document.getElementById('dayBox');
    const lblSub = document.getElementById('lblSub');

    if (!selSub) return; // ‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    selSub.innerHTML = "";

    if (type === 'daily' || type === 'monthly') {
        monthBox.classList.remove('hidden-completely');
        lblSub.innerText = (type === 'daily') ? "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å MONTHS_TH
        MONTHS_TH.forEach((m, i) => {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            const isSelected = (type === 'daily') ? (i === new Date().getMonth()) : true;
            selSub.add(new Option(m, i + 1, false, isSelected));
        });
        
        // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        dayBox.classList.toggle('hidden-completely', type === 'monthly');
    } 
    else if (type === 'quarterly') {
        monthBox.classList.remove('hidden-completely');
        dayBox.classList.add('hidden-completely');
        lblSub.innerText = "‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™";
        [1, 2, 3, 4].forEach(q => {
            selSub.add(new Option(`Q${q}`, q, false, true));
        });
    }

    processDashboard();
}

    // --- 4. RECORD LOGIC ---
   async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // 1. ‡∏õ‡∏£‡∏±‡∏ö Loading ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ Animation ‡∏´‡∏°‡∏∏‡∏ô‡∏ô‡∏≤‡∏ô)
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant UI Reset)
            inputs.forEach(i => i.value = ""); 
            
            // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                html: result.message,
                timer: 1000, // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏û‡∏≠
                showConfirmButton: false 
            });

            // 4. ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background Sync)
            initData(); 
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // 1. ‡∏õ‡∏£‡∏±‡∏ö Loading ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ Animation ‡∏´‡∏°‡∏∏‡∏ô‡∏ô‡∏≤‡∏ô)
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant UI Reset)
            inputs.forEach(i => i.value = ""); 
            
            // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                html: result.message,
                timer: 1000, // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏û‡∏≠
                showConfirmButton: false 
            });

            // 4. ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background Sync)
            initData(); 
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // 1. ‡∏õ‡∏£‡∏±‡∏ö Loading ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ Animation ‡∏´‡∏°‡∏∏‡∏ô‡∏ô‡∏≤‡∏ô)
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant UI Reset)
            inputs.forEach(i => i.value = ""); 
            
            // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                html: result.message,
                timer: 1000, // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏û‡∏≠
                showConfirmButton: false 
            });

            // 4. ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background Sync)
            initData(); 
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}async function saveWork() {
    const inputs = document.querySelectorAll('.cat-input');
    let items = [];
    inputs.forEach(i => { 
        const val = i.value.trim();
        if(val) items.push({ cat: i.dataset.cat, id: val }); 
    });
    
    if(!items.length) {
        Swal.fire({ icon: 'warning', title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Case ID', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // 1. ‡∏õ‡∏£‡∏±‡∏ö Loading ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ Animation ‡∏´‡∏°‡∏∏‡∏ô‡∏ô‡∏≤‡∏ô)
    Swal.fire({ 
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'saveWork', user: currentUser, items }) 
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Instant UI Reset)
            inputs.forEach(i => i.value = ""); 
            
            // 3. ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                html: result.message,
                timer: 1000, // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏û‡∏≠
                showConfirmButton: false 
            });

            // 4. ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background Sync)
            initData(); 
            
        } else {
            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: result.message });
        }
    } catch(e) { 
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', timer: 2000 }); 
    }
}
function processDashboard() {
    const type = document.getElementById('viewType').value, year = document.getElementById('selYear').value;
    const sub = Array.from(document.getElementById('selSub').selectedOptions).map(o => parseInt(o.value));
    const days = Array.from(document.getElementById('selDay').selectedOptions).map(o => parseInt(o.value));

    let groups = {};
    
    // 1. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Actual ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    allData.forEach(d => {
        const dt = new Date(d[0]), m = dt.getMonth() + 1, q = Math.ceil(m / 3);
        const cat = d[2]; // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (CP No., Call IN, etc.)
        
        if (d[1] !== currentUser || dt.getFullYear() != year) return;
        if ((type === 'daily' || type === 'monthly') && !sub.includes(m)) return;
        if (type === 'daily' && !days.includes(dt.getDate())) return;
        if (type === 'quarterly' && !sub.includes(q)) return;

        let key = type === 'daily' ? dt.toISOString().split('T')[0] : (type === 'monthly' ? `${year}-${m}` : `Q${q}`);
        
        if (!groups[key]) {
            groups[key] = { total: 0, target: 0, cp: 0, call: 0, ir: 0, sr: 0, drop: 0, camp: 0 };
        }
        
        groups[key].total++;
        // ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        if (cat === "CP No.") groups[key].cp++;
        else if (cat === "Call IN") groups[key].call++;
        else if (cat === "IR") groups[key].ir++;
        else if (cat === "SR") groups[key].sr++;
        else if (cat === "Drop Call") groups[key].drop++;
        else if (cat === "Campaign") groups[key].camp++;
    });

    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Target ‡∏à‡∏≤‡∏Å Plans
    allPlans.forEach(p => {
        const dt = new Date(p[0]), m = dt.getMonth() + 1, q = Math.ceil(m / 3);
        if (p[1] !== currentUser || dt.getFullYear() != year) return;
        
        let key = type === 'daily' ? dt.toISOString().split('T')[0] : (type === 'monthly' ? `${year}-${m}` : `Q${q}`);
        if (groups[key]) {
            groups[key].target += parseInt(p[3]);
        }
    });

    renderChart(groups);
    renderDashTable(groups);
}

function renderChart(groups) {
    const labels = Object.keys(groups).sort();
    if (chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(document.getElementById('perfChart'), {
        type: currentChartType,
        plugins: [ChartDataLabels],
        data: {
            labels,
            datasets: [
                { 
                    label: 'Actual', 
                    data: labels.map(l => groups[l].total), 
                    backgroundColor: '#ff8c00', 
                    borderColor: '#ff8c00', 
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3 
                },
                { 
                    label: 'Target', 
                    data: labels.map(l => groups[l].target), 
                    backgroundColor: '#b2bec3', 
                    borderColor: '#b2bec3', 
                    borderWidth: 2,
                    borderDash: [5, 5], // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Target
                    fill: false,
                    tension: 0 
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: true, position: 'top' },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#636e72',
                    font: { weight: 'bold', size: 10 }
                }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function renderDashTable(groups) {
    const keys = Object.keys(groups).sort().reverse();
    const tbody = document.getElementById('dashTableBody');
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô HTML)
    const tableHeader = document.querySelector('#tab-dash thead');
    tableHeader.innerHTML = `
        <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th class="text-orange">CP</th>
            <th>Call</th>
            <th>IR</th>
            <th>SR</th>
            <th>Drop</th>
            <th>Camp</th>
            <th class="table-primary">Actual</th>
            <th>Target</th>
            <th>%</th>
        </tr>
    `;

    tbody.innerHTML = keys.map(k => {
        const g = groups[k];
        const pct = g.target > 0 ? Math.round((g.total / g.target) * 100) : 0;
        const colorClass = pct >= 100 ? 'text-success' : (pct >= 80 ? 'text-warning' : 'text-danger');
        
        return `
            <tr>
                <td class="fw-bold">${k}</td>
                <td>${g.cp}</td>
                <td>${g.call}</td>
                <td>${g.ir}</td>
                <td>${g.sr}</td>
                <td>${g.drop}</td>
                <td>${g.camp}</td>
                <td class="table-primary fw-bold">${g.total}</td>
                <td class="text-muted">${g.target}</td>
                <td class="${colorClass} fw-bold">${pct}%</td>
            </tr>
        `;
    }).join('');
}

    // --- 7. UI HELPERS ---
    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-completely'));
        document.getElementById('tab-'+t).classList.remove('hidden-completely');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
        document.getElementById('nav-'+t).classList.add('active-btn');
        if(t === 'dash') processDashboard();
    }

    function toggleHistoryVisibility() {
        document.getElementById('historyContent').classList.toggle('hidden-completely');
    }

    function updateHistory() {
        const today = new Date().toISOString().split('T')[0];
        const history = allData.filter(d => d[0].split('T')[0] === today && d[1] === currentUser).reverse();
        document.getElementById('historyBody').innerHTML = history.map(d => `
            <tr><td>${new Date(d[0]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
            <td>${d[3]}</td><td>${d[2]}</td></tr>
        `).join('');
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('bigClock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
        document.getElementById('todayDateLabel').innerText = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long' });
    }, 1000);

    function changeChartType(t) {
        currentChartType = t;
        document.getElementById('btn-bar').classList.toggle('active', t==='bar');
        document.getElementById('btn-line').classList.toggle('active', t==='line');
        processDashboard();
    }
 function parseCPData() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á
    const val4G = document.getElementById('cpInput4G').value.trim();
    const val5G = document.getElementById('cpInput5G').value.trim();
    const valAddr = document.getElementById('cpInputAddr').value.trim();
    

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    const cleanLines = (text) => text.split('\n').map(l => l.trim()).filter(line => line.length > 0);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 4G (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ) ---
    if (val4G) {
        const lines4G = cleanLines(val4G);
        if (lines4G.length >= 2) document.getElementById('td-imsi').innerText = lines4G[1]; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 2
        if (lines4G.length >= 5) {
            // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1 + ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 5 + ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3
            document.getElementById('td-4gcell').innerText = `${lines4G[0]} ${lines4G[4]} ${lines4G[2]}`;
        }
        if (lines4G.length >= 7) document.getElementById('td-4grsrp').innerText = lines4G[6]; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 7
        if (lines4G.length >= 8) document.getElementById('td-4grsrq').innerText = lines4G[7]; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 8
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5G (‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ) ---
    if (val5G) {
        const lines5G = cleanLines(val5G);
        // IMSI: ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏≠‡∏á 4G ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á 5G ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2
        if (lines5G.length >= 2 && (document.getElementById('td-imsi').innerText === "-" || document.getElementById('td-imsi').innerText === "")) {
            document.getElementById('td-imsi').innerText = lines5G[1];
        }
        if (lines5G.length >= 5) {
            document.getElementById('td-5gcell').innerText = `${lines5G[0]} ${lines5G[4]} ${lines5G[2]}`;
        }
        if (lines5G.length >= 9) document.getElementById('td-5grsrp').innerText = lines5G[8]; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 9
        if (lines5G.length >= 10) document.getElementById('td-5gsinr').innerText = lines5G[9]; // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 10
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Address (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á -> ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ---
    if (valAddr) {
        const lines = cleanLines(valAddr); // ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢
        let addr = { no: "", bld: "", soi: "", rd: "", tmb: "", amp: "", prv: "", ldm: "" };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const findValue = (label) => {
            const idx = lines.findIndex(l => l.toLowerCase().includes(label.toLowerCase()));
            if (idx !== -1 && lines[idx + 1]) {
                let v = lines[idx + 1];
                return (v.includes("‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") || v === "-") ? "" : v;
            }
            return "";
        };

        addr.no = findValue("Address No.");
        addr.bld = findValue("Location/Building");
        addr.soi = findValue("Soi :");
        addr.rd = findValue("Road :");
        addr.tmb = findValue("Tumbol :");
        addr.amp = findValue("Amphur :");
        addr.prv = findValue("Province :");
        addr.ldm = findValue("‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï :");

        // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Horizontal) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        const formatted = [
            addr.no,
            addr.bld,
            addr.soi ? "‡∏ã." + addr.soi : "",
            addr.rd ? "‡∏ñ." + addr.rd : "",
            addr.tmb ? "‡∏ï." + addr.tmb : "",
            addr.amp ? "‡∏≠." + addr.amp : "",
            addr.prv ? "‡∏à." + addr.prv : "",
            addr.ldm ? "(‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: " + addr.ldm + ")" : ""
        ].filter(x => x).join(" ");

        document.getElementById('td-address').innerText = formatted || "-";
    }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
function clearCP() {
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Textarea ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà user ‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤
    const inputs = ['cpInput4G', 'cpInput5G', 'cpInputAddr'];
    inputs.forEach(id => {
        const inputEl = document.getElementById(id);
        if (inputEl) inputEl.value = "";
    });

    // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏≤‡∏™ .cp-value-custom ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "-" 
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πâ‡∏á IMSI, Address ‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á Remark/Package ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á
    document.querySelectorAll('.cp-value-custom').forEach(td => {
        td.innerText = "-";
    });

    // 3. ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (cpSummarySection) ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô Login ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    const summarySection = document.getElementById('cpSummarySection');
    if (summarySection) {
        summarySection.classList.add('d-none');
    }

    console.log("‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Input ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Copy Table ---
function copyCPTable() {
    const table = document.getElementById('cpTable');
    if (!table) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        return;
    }

    try {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Range ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const range = document.createRange();
        range.selectNode(table);
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
        const successful = document.execCommand('copy');
        
        // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏´‡∏•‡∏±‡∏á‡∏Å‡πä‡∏≠‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à
        selection.removeAllRanges();

        if (successful) {
            Swal.fire({
                icon: 'success',
                title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                text: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Line ‡∏´‡∏£‡∏∑‡∏≠ Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                timer: 1500,
                showConfirmButton: false
            });
        }
    } catch (err) {
        console.error('Copy failed', err);
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
    }
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Actual / Target / Badges) ---
function updateHomeStats() {
    // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const myTodayData = allData.filter(d => {
        const rowDate = new Date(d[0]).toISOString().split('T')[0];
        return rowDate === todayStr && d[1] === currentUser;
    });

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Target): ‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const myPlan = allPlans.find(p => {
        const planDate = new Date(p[0]).toISOString().split('T')[0];
        return planDate === todayStr && p[1] === currentUser;
    });

    const target = myPlan ? parseInt(myPlan[3]) : 0;
    const actual = myTodayData.length;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Actual / Target ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    document.getElementById('displayTarget').innerText = target;
    document.getElementById('displayActual').innerText = actual;
    document.getElementById('displayBalance').innerText = actual - target;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Badges)
    const badgeMap = { 
        "CP No.": "badge-CP", 
        "Call IN": "badge-Call", 
        "IR": "badge-IR", 
        "SR": "badge-SR", 
        "Drop Call": "badge-Drop", 
        "Campaign": "badge-Camp" 
    };

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Badge ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πà‡∏≠‡∏ô
    Object.values(badgeMap).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = "0";
    });

    // ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Badge
    myTodayData.forEach(d => {
        const category = d[2];
        const elementId = badgeMap[category];
        if (elementId) {
            const el = document.getElementById(elementId);
            el.innerText = parseInt(el.innerText) + 1;
        }
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress Bar
    const pct = target > 0 ? Math.min(Math.round((actual / target) * 100), 100) : 0;
    const bar = document.getElementById('goalProgress');
    bar.style.width = pct + "%";
    bar.innerText = pct + "%";
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ---
function updateHistory() {
    const todayStr = new Date().toISOString().split('T')[0];
    const historyBody = document.getElementById('historyBody');
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const history = allData.filter(d => {
        const rowDate = new Date(d[0]).toISOString().split('T')[0];
        return rowDate === todayStr && d[1] === currentUser;
    }).reverse();

    if (history.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }

    historyBody.innerHTML = history.map(d => {
        const time = new Date(d[0]).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        return `
            <tr>
                <td class="text-secondary">${time}</td>
                <td class="fw-bold">${d[3]}</td>
                <td><span class="badge bg-light text-dark border">${d[2]}</span></td>
            </tr>
        `;
    }).join('');
}
</script>
</body>
</html>