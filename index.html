<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V56 - Final Logic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --soft-orange: #ffb347; --peach: #fff5e6; --white: #ffffff; --text-dark: #5d4037; --deep-orange: #e67e22; --green: #27ae60; --red: #e74c3c; --yellow: #f1c40f; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--peach); color: var(--text-dark); }
        .glass-card { background: var(--white); border-radius: 20px; border: 2px solid #ffe0b2; box-shadow: 0 8px 20px rgba(255,179,71,0.1); padding: 20px; margin-bottom: 20px; }
        
        /* üé® Status Colors */
        .bal-pos { color: var(--green) !important; }
        .bal-zero { color: var(--yellow) !important; }
        .bal-neg { color: var(--red) !important; }

        /* üìä Progress Bar */
        .progress { height: 12px; border-radius: 10px; background-color: #eee; margin-bottom: 15px; }
        .progress-bar { transition: width 0.5s ease; }

        /* Case ID Input */
        .case-card { background: #fff; border: 1.5px solid #ffcc80; border-radius: 18px; padding: 15px; height: 100%; }
        .badge-circle { background: var(--deep-orange); color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; margin-right: 8px; }
        .case-label { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; margin-bottom: 12px; }
        .case-input-modern { border: 2px solid #eee; border-radius: 10px; font-size: 1rem; padding: 10px; width: 100%; text-align: center; font-weight: 600; color: var(--deep-orange); }
        
        .nav-btn { flex: 1; border-radius: 15px; font-weight: 600; border: 2px solid #ffe0b2; background: white; color: var(--soft-orange); padding: 10px; }
        .nav-btn.active-btn { background: var(--soft-orange) !important; color: white !important; }
        .hidden-completely { display: none !important; }
        .filter-row { display: flex; gap: 8px; overflow-x: auto; }
        .filter-item { min-width: 110px; flex: 1; }
    </style>
</head>
<body>

<div id="loginSection" style="position:fixed; width:100%; height:100%; z-index:9999; background:var(--peach); display:flex; align-items:center; justify-content:center;">
    <div class="glass-card text-center shadow-lg" style="width:90%; max-width:380px;">
        <h3 class="fw-bold mb-4" style="color: var(--deep-orange);">üçä Member Login</h3>
        <input type="text" id="user" class="form-control mb-3" placeholder="Username">
        <input type="password" id="pass" class="form-control mb-4" placeholder="Password">
        <button id="btnLogin" onclick="login()" class="btn btn-warning w-100 fw-bold text-white shadow-sm py-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="loginStatus" class="mt-3 small fw-bold text-muted" style="display:none;">‚åõ ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
    </div>
</div>

<div id="mainSection" class="hidden-completely">
    <nav class="navbar mb-3 p-3 glass-card mx-2 mt-2">
        <div class="container d-flex justify-content-between">
            <span class="fw-bold" style="color: #e65100;">üçä PRO V.56</span>
            <div class="text-end small">üë§ <span id="empName"></span> | <a href="#" onclick="logout()" class="text-danger fw-bold">Logout</a></div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex gap-2 mb-4 p-1 bg-white shadow-sm" style="border-radius: 20px;">
            <button id="nav-record" class="btn nav-btn active-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button id="nav-dash" class="btn nav-btn" onclick="showTab('dash')">Dashboard</button>
            <button id="nav-assign" class="btn nav-btn" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span id="displayDateText" class="small fw-bold text-muted">üìÖ -</span>
                    <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="manualRefresh()">üîÑ Sync</button>
                </div>
                <div id="bigClock" class="h1 fw-bold text-warning mb-1">00:00:00</div>
                
                <div class="px-2">
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span>Success Rate</span>
                        <span id="progressPctText">0%</span>
                    </div>
                    <div class="progress">
                        <div id="goalProgress" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                </div>

                <div class="row g-2">
                    <div class="col-4"><div class="stat-box p-2 border rounded-3">‡πÄ‡∏õ‡πâ‡∏≤<br><span id="displayTarget" class="h5 fw-bold">0</span></div></div>
                    <div class="col-4"><div class="stat-box p-2 border rounded-3">‡∏à‡∏£‡∏¥‡∏á<br><span id="displayActual" class="h5 fw-bold">0</span></div></div>
                    <div class="col-4"><div class="stat-box p-2 border rounded-3">+/-<br><span id="displayBalance" class="h5 fw-bold">0</span></div></div>
                </div>
                <div class="text-end mt-2" style="font-size: 0.7rem; color: #bbb;">Sync: <span class="last-sync-time">-</span></div>
            </div>

            <div class="row g-3">
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-CP">0</div>CP No.</div><input type="text" class="case-input-modern cat-input" data-cat="CP No." placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-Call">0</div>Call IN</div><input type="text" class="case-input-modern cat-input" data-cat="Call IN" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-IR">0</div>IR</div><input type="text" class="case-input-modern cat-input" data-cat="IR" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-DropCall">0</div>Drop</div><input type="text" class="case-input-modern cat-input" data-cat="Drop Call" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-SR">0</div>SR</div><input type="text" class="case-input-modern cat-input" data-cat="SR" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
                <div class="col-6 col-md-4"><div class="case-card"><div class="case-label"><div class="badge-circle" id="count-Campaign">0</div>Camp.</div><input type="text" class="case-input-modern cat-input" data-cat="Campaign" placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™"></div></div>
            </div>
            <button onclick="saveWork()" class="btn btn-warning w-100 text-white fw-bold mt-4 py-3 shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card">
                <div class="filter-row mb-3">
                    <div class="filter-item"><label class="small fw-bold">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="viewType" class="form-select form-select-sm" onchange="toggleFilters(); processDashboard();"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option><option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select></div>
                    <div class="filter-item" id="divYear"><label class="small fw-bold">‡∏õ‡∏µ</label><select id="selYear" class="form-select form-select-sm" multiple onchange="processDashboard();"></select></div>
                    <div class="filter-item hidden-completely" id="divQuarter"><label class="small fw-bold">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</label><select id="selQuarter" class="form-select form-select-sm" multiple onchange="processDashboard();"><option value="1" selected>Q1</option><option value="2" selected>Q2</option><option value="3" selected>Q3</option><option value="4" selected>Q4</option></select></div>
                    <div class="filter-item" id="divMonth"><label class="small fw-bold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select id="selMonth" class="form-select form-select-sm" multiple onchange="updateDayFilter(); processDashboard();"></select></div>
                    <div class="filter-item" id="divDay"><label class="small fw-bold">‡∏ß‡∏±‡∏ô</label><select id="selDay" class="form-select form-select-sm" multiple onchange="processDashboard();"></select></div>
                </div>
                <div style="height: 350px;"><canvas id="perfChart"></canvas></div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
            <div class="glass-card">
                <h6 class="fw-bold mb-3">üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</h6>
                <div class="row g-2 mb-3 p-2 bg-light rounded shadow-sm">
                    <div class="col-5"><input type="date" id="planDate" class="form-control form-control-sm"></div>
                    <div class="col-3"><select id="planType" class="form-select form-select-sm"><option value="72">72</option><option value="36">36</option></select></div>
                    <div class="col-4"><button onclick="savePlan('save')" class="btn btn-warning btn-sm w-100 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô</button></div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small fw-bold">Filter:</span>
                    <select id="assignFilter" class="form-select form-select-sm w-50" onchange="renderPlanTable()"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="weekly">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option><option value="monthly">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option></select>
                </div>
                <div class="table-responsive"><table class="table table-sm text-center small align-middle"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="planTableBody"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    let currentUser = "", allData = [], allPlans = [], chartInstance = null, currentChartType = 'bar';

    Chart.register(ChartDataLabels);

    async function login() {
        const u = document.getElementById('user').value.trim(), p = document.getElementById('pass').value.trim();
        if(!u || !p) return;
        document.getElementById('btnLogin').disabled = true; document.getElementById('loginStatus').style.display = 'block';
        try {
            const res = await (await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)).json();
            if (res.status === "success") {
                currentUser = res.name; document.getElementById('empName').innerText = res.name;
                document.getElementById('loginSection').classList.add('hidden-completely');
                document.getElementById('mainSection').classList.remove('hidden-completely');
                await refreshView(); initDashboardFilters();
            } else { Swal.fire('Error', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); document.getElementById('btnLogin').disabled = false; document.getElementById('loginStatus').style.display = 'none'; }
        } catch(e) { console.error(e); }
    }

    async function refreshView() {
        try {
            const res = await (await fetch(SCRIPT_URL)).json();
            allData = res.data.slice(1); allPlans = res.plans.slice(1);
            const todayStr = new Date().toISOString().split('T')[0];
            const myToday = allData.filter(d => (d[0]?d[0].split('T')[0]:"") === todayStr && d[1] === currentUser);
            const target = parseInt(allPlans.filter(p => p[1] === currentUser).find(p => p[0].split('T')[0] === todayStr)?.[3] || 0);
            
            // Stats Calculations
            const actual = myToday.length;
            const balance = actual - target;
            const balEl = document.getElementById('displayBalance');
            
            document.getElementById('displayTarget').innerText = target;
            document.getElementById('displayActual').innerText = actual;
            balEl.innerText = (balance > 0 ? "+" : "") + balance;
            
            // ‚úÖ Color Logic for Balance
            balEl.className = "h5 fw-bold " + (balance > 0 ? "bal-pos" : (balance === 0 ? "bal-zero" : "bal-neg"));

            // ‚úÖ Progress Bar Update
            const pct = target > 0 ? Math.min(Math.round((actual / target) * 100), 100) : 0;
            document.getElementById('goalProgress').style.width = pct + "%";
            document.getElementById('progressPctText').innerText = pct + "%";

            // ‚úÖ Time & Sync Update
            document.getElementById('displayDateText').innerText = "üìÖ " + new Date().toLocaleDateString('th-TH');
            document.querySelectorAll('.last-sync-time').forEach(el => el.innerText = new Date().toLocaleTimeString('th-TH'));

            const map = { "CP": "CP No.", "Call": "Call IN", "IR": "IR", "DropCall": "Drop Call", "SR": "SR", "Campaign": "Campaign" };
            for (let k in map) { document.getElementById(`count-${k}`).innerText = myToday.filter(r => r[2] === map[k]).length; }
            renderPlanTable();
        } catch(e) {}
    }

    // Dashboard & Filter Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å V55)
    function toggleFilters() {
        const t = document.getElementById('viewType').value;
        document.getElementById('divQuarter').classList.toggle('hidden-completely', t !== 'quarterly');
        document.getElementById('divMonth').classList.toggle('hidden-completely', t === 'yearly' || t === 'quarterly');
        document.getElementById('divDay').classList.toggle('hidden-completely', t !== 'daily');
        updateDayFilter();
    }
    function initDashboardFilters() {
        const years = [...new Set(allPlans.map(p => new Date(p[0]).getFullYear()))].sort((a,b)=>b-a);
        if(!years.length) years.push(new Date().getFullYear());
        document.getElementById('selYear').innerHTML = years.map(y => `<option value="${y}" selected>${y}</option>`).join('');
        const ms = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        document.getElementById('selMonth').innerHTML = ms.map((m, i) => `<option value="${i+1}" ${i+1===(new Date().getMonth()+1)?'selected':''}>${m}</option>`).join('');
        toggleFilters();
    }
    function updateDayFilter() {
        const ys = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const ms = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        let ds = allPlans.filter(p => p[1] === currentUser && ys.includes(new Date(p[0]).getFullYear().toString()) && ms.includes((new Date(p[0]).getMonth()+1).toString())).map(p => p[0].split('T')[0]);
        document.getElementById('selDay').innerHTML = [...new Set(ds)].sort().map(d => `<option value="${d}" selected>${d.split('-')[2]}/${d.split('-')[1]}</option>`).join('');
    }
    function processDashboard() {
        const type = document.getElementById('viewType').value, sY = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const sM = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value), sQ = Array.from(document.getElementById('selQuarter').selectedOptions).map(o => o.value), sD = Array.from(document.getElementById('selDay').selectedOptions).map(o => o.value);
        let groups = {};
        allPlans.filter(p => p[1] === currentUser).forEach(p => {
            const d = new Date(p[0]), y = d.getFullYear().toString(), m = (d.getMonth()+1).toString(), q = Math.ceil(parseInt(m)/3).toString(), f = p[0].split('T')[0];
            let key = (type==='yearly'&&sY.includes(y))?y : (type==='monthly'&&sY.includes(y)&&sM.includes(m))?`${m}/${y}` : (type==='quarterly'&&sY.includes(y)&&sQ.includes(q))?`Q${q}-${y}` : (type==='daily'&&sD.includes(f))?f : "";
            if(key) { if(!groups[key]) groups[key] = { t:0, a:0 }; groups[key].t += parseInt(p[3]); }
        });
        allData.filter(d => d[1] === currentUser).forEach(d => { const f = d[0].split('T')[0]; if(groups[f]) groups[f].a++; });
        const labels = Object.keys(groups).sort();
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('perfChart'), {
            type: 'bar', data: { labels: labels, datasets: [
                { label: '‡πÄ‡∏õ‡πâ‡∏≤', data: labels.map(l => groups[l].t), backgroundColor: '#ffe0b2', datalabels: { display: true, align: 'top' } },
                { label: '‡∏à‡∏£‡∏¥‡∏á', data: labels.map(l => groups[l].a), backgroundColor: '#ff7043', datalabels: { display: true, align: 'top' } }
            ]}, options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-completely'));
        document.getElementById('tab-' + t).classList.remove('hidden-completely');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-btn'));
        document.getElementById('nav-' + t).classList.add('active-btn');
        if(t === 'dash') processDashboard();
    }
    async function manualRefresh() { Swal.showLoading(); await refreshView(); Swal.close(); }
    function renderPlanTable() {
        const filter = document.getElementById('assignFilter').value;
        const now = new Date(); const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
        let f = allPlans.filter(p => p[1] === currentUser);
        if(filter === 'weekly') f = f.filter(p => new Date(p[0]) >= startOfWeek);
        else if(filter === 'monthly') f = f.filter(p => new Date(p[0]).getMonth() === new Date().getMonth());
        document.getElementById('planTableBody').innerHTML = f.sort((a,b)=>new Date(b[0])-new Date(a[0])).map(p => `<tr><td>${p[0].split('T')[0]}</td><td>${p[3]}</td><td><button class="btn btn-sm text-danger" onclick="savePlan('delete','${p[0].split('T')[0]}')">üóëÔ∏è</button></td></tr>`).join('');
    }
    async function savePlan(a, d) { await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'savePlan', subAction: a, date: d || document.getElementById('planDate').value, employee: currentUser, target: document.getElementById('planType').value})}); refreshView(); }
    async function saveWork() {
        const entries = []; document.querySelectorAll('.cat-input').forEach(i => { if(i.value.trim()) i.value.split(',').forEach(id => entries.push({category: i.dataset.cat, caseId: id.trim()})); });
        if(!entries.length) return;
        await fetch(SCRIPT_URL, { method:'POST', mode: 'no-cors', body: JSON.stringify({action:'saveData', date: new Date().toISOString().split('T')[0], employee: currentUser, target: document.getElementById('displayTarget').innerText, entries}) });
        document.querySelectorAll('.cat-input').forEach(i => i.value = ""); refreshView();
    }
    function logout() { location.reload(); }
    setInterval(() => { const el = document.getElementById('bigClock'); if(el) el.innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);
</script>
</body>
</html>