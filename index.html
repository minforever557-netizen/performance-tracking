<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance System V29</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --orange: #ff8c00; --green: #28a745; --red: #dc3545; --bg: #fffaf5; --blue: #0d6efd; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg); font-size: 0.9rem; }
        .hidden { display: none !important; }
        .glass-card { background: white; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange); color: white; border-radius: 50px; font-weight: 600; border: none; padding: 10px 20px; transition: 0.3s; }
        .btn-logout { background: #fee2e2; color: var(--red); border: 1px solid #fecaca; border-radius: 10px; font-size: 0.75rem; padding: 4px 12px; font-weight: 600; }
        .stat-box { border-left: 5px solid var(--orange); background: #fff; padding: 10px; border-radius: 10px; position: relative; }
        .badge-count { position: absolute; top: 5px; right: 10px; background: var(--orange); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .nav-btn { flex: 1; border-radius: 12px; font-weight: 600; font-size: 0.85rem; }
        .table-custom { font-size: 0.8rem; text-align: center; }
        .table-custom thead { background: var(--orange); color: white; }
        .sync-tag { font-size: 0.75rem; color: #666; background: #e9ecef; padding: 2px 8px; border-radius: 20px; display: inline-block; }
    </style>
</head>
<body>

<div id="loginSection" class="container d-flex align-items-center justify-content-center" style="min-height:100vh;">
    <div class="glass-card text-center shadow" style="max-width:380px; width:100%;">
        <h3 class="fw-bold mb-4 text-orange">üü† PERFORMANCE V29</h3>
        <input type="text" id="user" class="form-control mb-3" placeholder="Username">
        <input type="password" id="pass" class="form-control mb-4" placeholder="Password">
        <button onclick="login()" class="btn btn-orange w-100 shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="mainSection" class="hidden">
    <nav class="navbar mb-3 p-3 glass-card mx-2 mt-2">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand fw-bold text-orange">üü† Analytics Tool</span>
            <div class="d-flex align-items-center gap-3">
                <div id="liveClock" class="fw-bold text-secondary d-none d-sm-block small">00:00:00</div>
                <div class="text-end">
                    <div class="small fw-bold">üë§ <span id="empName"></span></div>
                    <button onclick="logout()" class="btn-logout mt-1">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex gap-2 mb-4">
            <button id="nav-rec" class="btn btn-orange nav-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button id="nav-dash" class="btn btn-outline-secondary nav-btn" onclick="showTab('dash')">Dashboard</button>
            <button id="nav-assign" class="btn btn-outline-secondary nav-btn" onclick="showTab('assign')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content">
            <div class="glass-card text-center mb-3">
                <h6 id="displayDateText" class="fw-bold text-secondary mb-1"></h6>
                <div class="sync-tag mb-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span class="lastSyncDisplay">-</span></div>
                <div class="row g-2">
                    <div class="col-6"><div class="stat-box shadow-sm">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span id="displayTarget" class="fw-bold text-orange">0</span></div></div>
                    <div class="col-6"><div class="stat-box shadow-sm" style="border-left-color:var(--green)">‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á: <span id="displayActual" class="fw-bold text-success">0</span></div></div>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üì¶ CP No. <span class="badge-count" id="count-CP">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="CP No."></div></div>
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üìû Call IN <span class="badge-count" id="count-Call">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="Call IN"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üìÑ IR <span class="badge-count" id="count-IR">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="IR"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üåê GNS <span class="badge-count" id="count-GNS">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="GNS"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üõ†Ô∏è SR <span class="badge-count" id="count-SR">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="SR"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box shadow-sm">üéÅ Campaign <span class="badge-count" id="count-Campaign">0</span><input type="text" class="form-control mt-1 cat-input" data-cat="Campaign"></div></div>
            </div>
            <button onclick="saveWork()" class="btn btn-orange w-100 mt-4 py-3 shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</button>
            <div class="text-center mt-3"><button onclick="manualRefresh()" class="btn btn-sm btn-link text-secondary">üîÑ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button></div>
        </div>

        <div id="tab-dash" class="tab-content hidden">
            <div class="glass-card mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold text-orange m-0">üìä Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•</h6>
                    <button onclick="manualRefresh()" class="btn btn-sm btn-primary px-3 shadow-sm">üîÑ Refresh Data</button>
                </div>
                <div class="sync-tag mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤: <span class="lastSyncDisplay">-</span></div>
                <div class="row g-2">
                    <div class="col-md-3"><label class="small text-muted">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="viewType" class="form-select" onchange="toggleFilters()"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option><option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select></div>
                    <div class="col-md-3" id="divYear"><label class="small text-muted">‡∏õ‡∏µ</label><select id="selYear" class="form-select" multiple onchange="updateSubFilters()"></select></div>
                    <div class="col-md-3" id="divMonth"><label class="small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</label><select id="selMonth" class="form-select" multiple onchange="updateDayFilter()"></select></div>
                    <div class="col-md-3" id="divDay"><label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><select id="selDay" class="form-select" multiple></select></div>
                </div>
                <button onclick="processDashboard()" class="btn btn-orange w-100 mt-3 shadow">üìà ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
            </div>
            <div class="glass-card shadow-sm" style="height: 350px;"><canvas id="perfChart"></canvas></div>
            <div class="glass-card"><div class="table-responsive"><table class="table table-sm table-bordered table-custom"><thead><tr><th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏õ‡πâ‡∏≤</th><th>‡∏à‡∏£‡∏¥‡∏á</th><th>Call</th><th>IR</th><th>CP</th><th>GNS</th><th>SR</th><th>Camp.</th></tr></thead><tbody id="dashTableBody"></tbody></table></div></div>
        </div>

        <div id="tab-assign" class="tab-content hidden">
            <div class="glass-card mb-4">
                <h5 class="fw-bold text-orange mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h5>
                <div class="row g-2">
                    <div class="col-md-5"><input type="date" id="planDate" class="form-control"></div>
                    <div class="col-md-4"><select id="planType" class="form-select"><option value="72">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (72)</option><option value="36">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô (36)</option></select></div>
                    <div class="col-md-3"><button onclick="savePlan('save')" class="btn btn-orange w-100 shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                </div>
            </div>
            <div class="glass-card"><div class="table-responsive"><table class="table table-sm table-custom text-center"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="planTableBody"></tbody></table></div></div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    let currentUser = "", allData = [], allPlans = [], chartInstance = null;

    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);

    function logout() { currentUser = ""; location.reload(); }

    async function login() {
        const u = document.getElementById('user').value.trim(), p = document.getElementById('pass').value.trim();
        if(!u || !p) return;
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        try {
            const res = await (await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)).json();
            if (res.status === "success") {
                currentUser = res.name;
                document.getElementById('empName').innerText = res.name;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                await refreshView();
                Swal.close();
            } else { Swal.fire('Error', 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        } catch (e) { Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
    }

    async function manualRefresh() { 
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', timer: 1200, showConfirmButton: false, didOpen: () => Swal.showLoading()});
        await refreshView(); 
    }

    async function refreshView() {
        try {
            const res = await (await fetch(SCRIPT_URL)).json();
            allData = res.data.slice(1); 
            allPlans = res.plans.slice(1);
            
            const nowTime = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            document.querySelectorAll('.lastSyncDisplay').forEach(el => el.innerText = nowTime);

            const today = new Date().toISOString().split('T')[0];
            const userPlans = allPlans.filter(p => p[1] === currentUser);
            const todayData = allData.filter(d => d[0].split('T')[0] === today && d[1] === currentUser);
            
            document.getElementById('displayTarget').innerText = userPlans.find(p => p[0].split('T')[0] === today)?.[3] || 0;
            document.getElementById('displayActual').innerText = todayData.length;
            document.getElementById('displayDateText').innerText = '‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + new Date().toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'numeric'});

            const cats = { "CP": "CP No.", "Call": "Call IN", "IR": "IR", "GNS": "GNS", "SR": "SR", "Campaign": "Campaign" };
            for (let id in cats) document.getElementById(`count-${id}`).innerText = todayData.filter(d => d[2] === cats[id]).length;
            
            let planHtml = ""; 
            userPlans.sort((a,b)=>new Date(b[0])-new Date(a[0])).slice(0,5).forEach(p => {
                planHtml += `<tr><td>${new Date(p[0]).toLocaleDateString('th-TH')}</td><td>${p[3]}</td><td><button class="btn btn-sm btn-danger px-2" onclick="savePlan('delete','${p[0].split('T')[0]}')">‡∏•‡∏ö</button></td></tr>`;
            });
            document.getElementById('planTableBody').innerHTML = planHtml || '<tr><td colspan="3" class="text-muted py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</td></tr>';
        } catch(e) { console.error("Refresh Error", e); }
    }

    async function saveWork() {
        const entries = []; 
        document.querySelectorAll('.cat-input').forEach(i => { if(i.value.trim()) entries.push({category: i.dataset.cat, caseId: i.value.trim()}); });
        if(!entries.length) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Case ID', 'warning');
        
        Swal.showLoading();
        const res = await (await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'saveData', date: new Date().toISOString().split('T')[0], employee: currentUser, target: document.getElementById('displayTarget').innerText, entries})})).json();
        
        if(res.status === "success") { 
            document.querySelectorAll('.cat-input').forEach(i => i.value = ""); 
            await refreshView(); 
            Swal.fire({icon:'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', timer:1000, showConfirmButton:false}); 
        } else { Swal.fire('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.msg, 'error'); }
    }

    // DASHBOARD LOGIC (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô V28)
    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + t).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('btn-orange', 'btn-outline-secondary'));
        document.getElementById('nav-' + (t==='record'?'rec':t)).classList.replace('btn-outline-secondary', 'btn-orange');
        if(t === 'dash') initDashboard();
    }
    function initDashboard() {
        const years = [...new Set(allPlans.filter(p => p[1] === currentUser).map(p => new Date(p[0]).getFullYear()))].sort((a,b)=>b-a);
        document.getElementById('selYear').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
        toggleFilters();
    }
    function toggleFilters() {
        const t = document.getElementById('viewType').value;
        document.getElementById('divMonth').classList.toggle('hidden', t === 'yearly');
        document.getElementById('divDay').classList.toggle('hidden', t !== 'daily');
        updateSubFilters();
    }
    function updateSubFilters() {
        const t = document.getElementById('viewType').value; 
        const selM = document.getElementById('selMonth');
        const ms = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        if (t === 'daily' || t === 'monthly') selM.innerHTML = ms.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
        else if (t === 'quarterly') selM.innerHTML = `<option value="1">Q1</option><option value="2">Q2</option><option value="3">Q3</option><option value="4">Q4</option>`;
    }
    function updateDayFilter() {
        const ys = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const ms = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        let ds = allPlans.filter(p => p[1] === currentUser && ys.includes(new Date(p[0]).getFullYear().toString()) && ms.includes((new Date(p[0]).getMonth()+1).toString())).map(p => p[0].split('T')[0]);
        document.getElementById('selDay').innerHTML = [...new Set(ds)].sort().map(d => `<option value="${d}">${new Date(d).getDate()}/${new Date(d).getMonth()+1}</option>`).join('');
    }
    function processDashboard() {
        const type = document.getElementById('viewType').value;
        const sY = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const sM = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        const sD = Array.from(document.getElementById('selDay').selectedOptions).map(o => o.value);
        let groups = {};
        allPlans.filter(p => p[1] === currentUser).forEach(p => {
            const d = new Date(p[0]), y = d.getFullYear().toString(), m = (d.getMonth()+1).toString(), q = Math.ceil(m/3).toString(), f = p[0].split('T')[0];
            let k = "";
            if(type === 'yearly' && sY.includes(y)) k = y;
            else if(type === 'quarterly' && sY.includes(y) && sM.includes(q)) k = `Q${q}/${y}`;
            else if(type === 'monthly' && sY.includes(y) && sM.includes(m)) k = `${m}/${y}`;
            else if(type === 'daily' && sD.includes(f)) k = f;
            if(k) { if(!groups[k]) groups[k] = { t: 0, a: 0, c: {} }; groups[k].t += parseInt(p[3]); }
        });
        allData.filter(d => d[1] === currentUser).forEach(d => {
            const date = new Date(d[0]), y = date.getFullYear().toString(), m = (date.getMonth()+1).toString(), q = Math.ceil(m/3).toString(), f = d[0].split('T')[0], cat = d[2];
            let k = "";
            if(type === 'yearly' && sY.includes(y)) k = y;
            else if(type === 'quarterly' && sY.includes(y) && sM.includes(q)) k = `Q${q}/${y}`;
            else if(type === 'monthly' && sY.includes(y) && sM.includes(m)) k = `${m}/${y}`;
            else if(type === 'daily' && sD.includes(f)) k = f;
            if(k && groups[k]) { groups[k].a++; groups[k].c[cat] = (groups[k].c[cat] || 0) + 1; }
        });
        if (chartInstance) chartInstance.destroy();
        const labs = Object.keys(groups);
        chartInstance = new Chart(document.getElementById('perfChart'), {
            type: 'bar',
            data: { labels: labs, datasets: [{ label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', data: labs.map(l => groups[l].t), backgroundColor: '#28a745' }, { label: '‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á', data: labs.map(l => groups[l].a), backgroundColor: '#ff8c00' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        let h = ""; labs.forEach(l => {
            h += `<tr><td class="fw-bold">${l}</td><td>${groups[l].t}</td><td class="text-primary fw-bold">${groups[l].a}</td><td>${groups[l].c['Call IN']||0}</td><td>${groups[l].c['IR']||0}</td><td>${groups[l].c['CP No.']||0}</td><td>${groups[l].c['GNS']||0}</td><td>${groups[l].c['SR']||0}</td><td>${groups[l].c['Campaign']||0}</td></tr>`;
        });
        document.getElementById('dashTableBody').innerHTML = h || '<tr><td colspan="9">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }
    async function savePlan(a, d) { 
        Swal.showLoading();
        await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'savePlan', subAction: a, date: d || document.getElementById('planDate').value, employee: currentUser, target: document.getElementById('planType').value, workType:'Plan'})}); 
        await refreshView(); 
        Swal.close();
    }
</script>
</body>
</html>