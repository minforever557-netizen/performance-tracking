<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance V39 - Full Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --soft-orange: #ffb347; --peach: #fff5e6; --white: #ffffff; --text-dark: #5d4037; --green: #2ecc71; --red: #e74c3c; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--peach); background-image: radial-gradient(#ffcc80 0.5px, transparent 0.5px); background-size: 20px 20px; min-height: 100vh; color: var(--text-dark); margin: 0; padding: 0; }
        #loginSection { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--peach); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .glass-card { background: var(--white); border-radius: 20px; border: 2px solid #ffe0b2; box-shadow: 0 8px 20px rgba(255, 179, 71, 0.1); padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--soft-orange); color: white; border-radius: 50px; font-weight: 600; border: none; padding: 10px 20px; box-shadow: 0 4px 10px rgba(255, 179, 71, 0.3); transition: 0.2s; }
        .stat-box { background: #fff9f0; border-left: 5px solid var(--soft-orange); padding: 12px; border-radius: 15px; position: relative; }
        .badge-count { position: absolute; top: -5px; right: -5px; background: #ff7043; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .nav-btn { flex: 1; border-radius: 15px; font-weight: 600; border: 2px solid #ffe0b2; background: white; color: var(--soft-orange); }
        .nav-btn.active-btn { background: var(--soft-orange); color: white; border-color: var(--soft-orange); }
        .live-time-display { font-size: 2.5rem; font-weight: 600; color: #e65100; margin-bottom: 5px; letter-spacing: 2px; }
        .hidden-completely { display: none !important; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: 0.2em; margin-right: 8px; }
    </style>
</head>
<body>

<div id="loginSection">
    <div class="glass-card text-center shadow-lg" style="max-width:380px; width:90%; border-top: 8px solid var(--soft-orange);">
        <h2 class="fw-bold mb-4" style="color: var(--soft-orange);">üçä Performance</h2>
        <div id="loginForm">
            <input type="text" id="user" class="form-control mb-3 py-2" placeholder="Username">
            <input type="password" id="pass" class="form-control mb-4 py-2" placeholder="Password">
            <button id="btnLogin" onclick="login()" class="btn btn-orange w-100 py-2 shadow"><span id="loginText">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></button>
        </div>
        <div id="loginStatus" class="mt-3 small text-muted hidden-completely">
            <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
            <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°...</span>
        </div>
    </div>
</div>

<div id="mainSection" class="hidden-completely">
    <nav class="navbar mb-3 p-3 glass-card mx-2 mt-2">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand fw-bold" style="color: #e65100;">üçä Performance V.39</span>
            <div class="text-end">
                <div class="small fw-bold">üë§ <span id="empName"></span></div>
                <button onclick="logout()" class="btn btn-sm btn-link text-danger text-decoration-none p-0">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex gap-2 mb-4 p-1 bg-white shadow-sm" style="border-radius: 20px;">
            <button id="nav-rec" class="btn nav-btn active-btn" onclick="showTab('record')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button id="nav-dash" class="btn nav-btn" onclick="showTab('dash')">Dashboard</button>
            <button id="nav-assign" class="btn nav-btn" onclick="showTab('assign')">‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-record" class="tab-content text-center">
            <div class="glass-card mb-3">
                <div id="bigClock" class="live-time-display">00:00:00</div>
                <h6 id="displayDateText" class="fw-bold text-muted mb-3"></h6>
                <div class="row g-2 mt-2">
                    <div class="col-4"><div class="stat-box shadow-sm small">‡πÄ‡∏õ‡πâ‡∏≤<br><span id="displayTarget" class="h5 fw-bold">0</span></div></div>
                    <div class="col-4"><div class="stat-box shadow-sm small" style="border-left-color:var(--green)">‡∏à‡∏£‡∏¥‡∏á<br><span id="displayActual" class="h5 fw-bold text-success">0</span></div></div>
                    <div class="col-4"><div class="stat-box shadow-sm small" id="balanceBox">+/-<br><span id="displayBalance" class="h5 fw-bold">0</span></div></div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-6 col-md-4"><div class="stat-box">üì¶ CP No. <span class="badge-count" id="count-CP">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="CP No."></div></div>
                <div class="col-6 col-md-4"><div class="stat-box">üìû Call IN <span class="badge-count" id="count-Call">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="Call IN"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box">üìÑ IR <span class="badge-count" id="count-IR">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="IR"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box">üìµ Drop Call <span class="badge-count" id="count-DropCall">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="Drop Call"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box">üõ†Ô∏è SR <span class="badge-count" id="count-SR">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="SR"></div></div>
                <div class="col-6 col-md-4"><div class="stat-box">üéÅ Camp. <span class="badge-count" id="count-Campaign">0</span><input type="text" class="form-control mt-2 cat-input" data-cat="Campaign"></div></div>
            </div>
            <button onclick="saveWork()" class="btn btn-orange w-100 mt-4 py-3 shadow">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-dash" class="tab-content hidden-completely">
            <div class="glass-card mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Performance</h6>
                    <button onclick="manualRefresh()" class="btn btn-sm btn-orange px-3 shadow-sm">üîÑ Sync</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-3"><label class="small fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="viewType" class="form-select" onchange="toggleFilters(); processDashboard();"><option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option><option value="quarterly">‡∏£‡∏≤‡∏¢‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</option><option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option></select></div>
                    <div class="col-md-3" id="divYear"><label class="small fw-bold">‡∏õ‡∏µ</label><select id="selYear" class="form-select" multiple onchange="updateSubFilters(); processDashboard();"></select></div>
                    <div class="col-md-3" id="divMonth"><label class="small fw-bold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><select id="selMonth" class="form-select" multiple onchange="updateDayFilter(); processDashboard();"></select></div>
                    <div class="col-md-3" id="divDay"><label class="small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><select id="selDay" class="form-select" multiple onchange="processDashboard();"></select></div>
                </div>
            </div>
            <div class="glass-card" style="height: 380px;"><canvas id="perfChart"></canvas></div>
            <div class="glass-card px-0 overflow-hidden shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover text-center mb-0" style="font-size: 0.9rem;">
                        <thead style="background: #fff3e0; color: #e65100;">
                            <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏õ‡πâ‡∏≤</th><th>‡∏à‡∏£‡∏¥‡∏á</th><th>+/-</th><th>Call</th><th>IR</th><th>CP</th><th>Drop</th><th>SR</th></tr>
                        </thead>
                        <tbody id="dashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-assign" class="tab-content hidden-completely">
            <div class="glass-card">
                <h5 class="fw-bold mb-3">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h5>
                <div class="row g-2 mb-4">
                    <div class="col-md-5"><input type="date" id="planDate" class="form-control"></div>
                    <div class="col-md-4"><select id="planType" class="form-select"><option value="72">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (72)</option><option value="36">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô (36)</option></select></div>
                    <div class="col-md-3"><button onclick="savePlan('save')" class="btn btn-orange w-100 shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                </div>
                <table class="table text-center table-sm">
                    <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Target</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody id="planTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQwqm_s6_0S6bcBX6xYXb8pLzxDJy5-m5AotyIV4f6uJPxYmTrmNkaXWQsGpk0PwY/exec';
    let currentUser = "", allData = [], allPlans = [], chartInstance = null;
    Chart.register(ChartDataLabels);

    setInterval(() => {
        const el = document.getElementById('bigClock');
        if(el) el.innerText = new Date().toLocaleTimeString('th-TH', { hour12: false });
    }, 1000);

    function setStatus(text, show = true) {
        document.getElementById('statusText').innerText = text;
        document.getElementById('loginStatus').classList.toggle('hidden-completely', !show);
    }

    async function login() {
        const u = document.getElementById('user').value.trim(), p = document.getElementById('pass').value.trim(), btn = document.getElementById('btnLogin');
        if(!u || !p) return;
        btn.disabled = true; document.getElementById('loginText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."; setStatus("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...", true);
        try {
            const res = await (await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)).json();
            if (res.status === "success") {
                setStatus("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...");
                currentUser = res.name; document.getElementById('empName').innerText = res.name;
                await refreshView(); 
                setStatus("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...");
                setTimeout(() => {
                    document.getElementById('loginSection').classList.add('hidden-completely');
                    document.getElementById('mainSection').classList.remove('hidden-completely');
                }, 300);
            } else { Swal.fire('Error', 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); resetLoginBtn(); }
        } catch(e) { Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); resetLoginBtn(); }
    }

    function resetLoginBtn() {
        const btn = document.getElementById('btnLogin'); btn.disabled = false;
        document.getElementById('loginText').innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; setStatus("", false);
    }

    function logout() { location.reload(); }

    function autoUpdateUI(entries) {
        const actualEl = document.getElementById('displayActual'), targetEl = document.getElementById('displayTarget'), balEl = document.getElementById('displayBalance');
        let newActual = parseInt(actualEl.innerText) + entries.length, tar = parseInt(targetEl.innerText), bal = newActual - tar;
        actualEl.innerText = newActual;
        balEl.innerText = (bal > 0 ? "+" : "") + bal;
        balEl.className = "h5 fw-bold " + (bal >= 0 ? "text-success" : "text-danger");
        document.getElementById('balanceBox').style.borderLeftColor = bal >= 0 ? "var(--green)" : "var(--red)";
        entries.forEach(item => {
            const catIdMap = { "CP No.": "count-CP", "Call IN": "count-Call", "IR": "count-IR", "Drop Call": "count-DropCall", "SR": "count-SR", "Campaign": "count-Campaign" };
            const badge = document.getElementById(catIdMap[item.category]);
            if(badge) badge.innerText = parseInt(badge.innerText) + 1;
        });
    }

    async function refreshView() {
        try {
            const res = await (await fetch(SCRIPT_URL)).json();
            allData = res.data.slice(1); allPlans = res.plans.slice(1);
            const now = new Date(), todayStr = now.toISOString().split('T')[0];
            const userPlans = allPlans.filter(p => p[1] === currentUser);
            const todayData = allData.filter(d => d[0].split('T')[0] === todayStr && d[1] === currentUser);
            const target = parseInt(userPlans.find(p => p[0].split('T')[0] === todayStr)?.[3] || 0);
            document.getElementById('displayTarget').innerText = target;
            document.getElementById('displayActual').innerText = todayData.length;
            const bal = todayData.length - target;
            const balEl = document.getElementById('displayBalance');
            balEl.innerText = (bal > 0 ? "+" : "") + bal;
            balEl.className = "h5 fw-bold " + (bal >= 0 ? "text-success" : "text-danger");
            document.getElementById('balanceBox').style.borderLeftColor = bal >= 0 ? "var(--green)" : "var(--red)";
            document.getElementById('displayDateText').innerText = 'üìÖ ' + now.toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'});
            const cats = { "CP": "CP No.", "Call": "Call IN", "IR": "IR", "DropCall": "Drop Call", "SR": "SR", "Campaign": "Campaign" };
            for (let id in cats) {
                const el = document.getElementById(`count-${id}`);
                if(el) el.innerText = todayData.filter(d => d[2] === cats[id]).length;
            }
            let h = ""; userPlans.sort((a,b)=>new Date(b[0])-new Date(a[0])).slice(0,5).forEach(p => {
                h += `<tr><td>${new Date(p[0]).toLocaleDateString('th-TH')}</td><td>${p[3]}</td><td><button class="btn btn-sm text-danger" onclick="savePlan('delete','${p[0].split('T')[0]}')">‡∏•‡∏ö</button></td></tr>`;
            });
            document.getElementById('planTableBody').innerHTML = h;
            if(!document.getElementById('tab-dash').classList.contains('hidden-completely')) processDashboard();
        } catch(e) { console.error("Sync Error", e); }
    }

    async function saveWork() {
        const entries = []; 
        document.querySelectorAll('.cat-input').forEach(i => { if(i.value.trim()) entries.push({category: i.dataset.cat, caseId: i.value.trim()}); });
        if(!entries.length) return;
        autoUpdateUI(entries);
        document.querySelectorAll('.cat-input').forEach(i => i.value = ""); 
        fetch(SCRIPT_URL, { method:'POST', mode: 'no-cors', body: JSON.stringify({action:'saveData', date: new Date().toISOString().split('T')[0], employee: currentUser, target: document.getElementById('displayTarget').innerText, entries}) }).then(() => refreshView());
        Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000, icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    function showTab(t) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-completely'));
        document.getElementById('tab-' + t).classList.remove('hidden-completely');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-btn'));
        document.getElementById('nav-' + (t==='record'?'rec':t)).classList.add('active-btn');
        if(t === 'dash') { initDashboard(); }
    }

    function initDashboard() {
        const years = [...new Set(allPlans.filter(p => p[1] === currentUser).map(p => new Date(p[0]).getFullYear()))].sort((a,b)=>b-a);
        if(!years.length) years.push(new Date().getFullYear());
        document.getElementById('selYear').innerHTML = years.map(y => `<option value="${y}" selected>${y}</option>`).join('');
        toggleFilters();
    }

    function toggleFilters() {
        const t = document.getElementById('viewType').value;
        document.getElementById('divMonth').classList.toggle('hidden-completely', t === 'yearly' || t === 'quarterly');
        document.getElementById('divDay').classList.toggle('hidden-completely', t !== 'daily');
        updateSubFilters();
    }

    function updateSubFilters() {
        const t = document.getElementById('viewType').value, selM = document.getElementById('selMonth');
        const ms = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        const currentM = new Date().getMonth() + 1;
        selM.innerHTML = ms.map((m, i) => `<option value="${i+1}" ${i+1===currentM?'selected':''}>${m}</option>`).join('');
        updateDayFilter();
    }

    function updateDayFilter() {
        const ys = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const ms = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        let ds = allPlans.filter(p => p[1] === currentUser && ys.includes(new Date(p[0]).getFullYear().toString()) && ms.includes((new Date(p[0]).getMonth()+1).toString())).map(p => p[0].split('T')[0]);
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('selDay').innerHTML = [...new Set(ds)].sort().map(d => `<option value="${d}" ${d===todayStr?'selected':''}>${new Date(d).getDate()}/${new Date(d).getMonth()+1}</option>`).join('');
    }

    function processDashboard() {
        const type = document.getElementById('viewType').value;
        const sY = Array.from(document.getElementById('selYear').selectedOptions).map(o => o.value);
        const sM = Array.from(document.getElementById('selMonth').selectedOptions).map(o => o.value);
        const sD = Array.from(document.getElementById('selDay').selectedOptions).map(o => o.value);
        let groups = {};

        allPlans.filter(p => p[1] === currentUser).forEach(p => {
            const d = new Date(p[0]), y = d.getFullYear().toString(), m = (d.getMonth()+1).toString(), q = "Q" + Math.ceil(m/3), f = p[0].split('T')[0];
            let k = (type==='yearly'&&sY.includes(y))?y:(type==='quarterly'&&sY.includes(y))?`${q}/${y}`:(type==='monthly'&&sY.includes(y)&&sM.includes(m))?`${m}/${y}`:(type==='daily'&&sD.includes(f))?f:"";
            if(k) { if(!groups[k]) groups[k] = { t: 0, a: 0, c: {} }; groups[k].t += parseInt(p[3]); }
        });

        allData.filter(d => d[1] === currentUser).forEach(d => {
            const date = new Date(d[0]), y = date.getFullYear().toString(), m = (date.getMonth()+1).toString(), q = "Q" + Math.ceil(m/3), f = d[0].split('T')[0], cat = d[2];
            let k = (type==='yearly'&&sY.includes(y))?y:(type==='quarterly'&&sY.includes(y))?`${q}/${y}`:(type==='monthly'&&sY.includes(y)&&sM.includes(m))?`${m}/${y}`:(type==='daily'&&sD.includes(f))?f:"";
            if(k && groups[k]) { groups[k].a++; groups[k].c[cat] = (groups[k].c[cat] || 0) + 1; }
        });

        const labs = Object.keys(groups).sort();
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('perfChart'), {
            type: 'bar',
            data: { labels: labs, datasets: [{ label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', data: labs.map(l => groups[l].t), backgroundColor: '#ffcc80', borderRadius: 5 }, { label: '‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á', data: labs.map(l => groups[l].a), backgroundColor: '#ff7043', borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#5d4037', font: { weight: 'bold' } } } }
        });

        let h = ""; labs.forEach(l => {
            const bal = groups[l].a - groups[l].t;
            h += `<tr><td>${l}</td><td>${groups[l].t}</td><td class="fw-bold text-orange">${groups[l].a}</td><td class="${bal>=0?'text-success':'text-danger'} fw-bold">${(bal>0?"+":"")+bal}</td><td>${groups[l].c['Call IN']||0}</td><td>${groups[l].c['IR']||0}</td><td>${groups[l].c['CP No.']||0}</td><td>${groups[l].c['Drop Call']||0}</td><td>${groups[l].c['SR']||0}</td></tr>`;
        });
        document.getElementById('dashTableBody').innerHTML = h;
    }

    async function savePlan(a, d) { Swal.showLoading(); await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:'savePlan', subAction: a, date: d || document.getElementById('planDate').value, employee: currentUser, target: document.getElementById('planType').value, workType:'Plan'})}); await refreshView(); Swal.close(); }
    async function manualRefresh() { Swal.fire({title:'Syncing...', didOpen:()=>Swal.showLoading(), timer: 800}); await refreshView(); }
</script>
</body>
</html>